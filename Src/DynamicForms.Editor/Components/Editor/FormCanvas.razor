@using DynamicForms.Editor.Components.Editor.Canvas
@using DynamicForms.Editor.Services
@using DynamicForms.Core.V4.Runtime

<div class="form-canvas" @onclick="HandleCanvasClick">
    <div class="form-canvas-content">
        <div class="canvas-header">
            <h2 class="canvas-title">@(EditorState.CurrentModule?.TitleEn ?? "No Module Loaded")</h2>
            @if (!string.IsNullOrEmpty(EditorState.CurrentModule?.DescriptionEn))
            {
                <p class="canvas-description">@EditorState.CurrentModule.DescriptionEn</p>
            }
        </div>
        
        @if (RootFields.Any())
        {
            @foreach (var field in RootFields)
            {
                <CanvasField Field="@field" />
            }
        }
        else
        {
            <div class="empty-canvas">
                <i class="bi bi-plus-square-dotted"></i>
                <p>Add your first field from the palette</p>
            </div>
        }
    </div>
</div>

@code {
    [Inject] private IEditorStateService EditorState { get; set; } = default!;
    
    private IEnumerable<FormFieldNode> RootFields => EditorState.CurrentModuleRuntime?.RootFields
        .OrderBy(f => f.Schema.Order) ?? Enumerable.Empty<FormFieldNode>();
    
    protected override void OnInitialized()
    {
        EditorState.OnStateChanged += StateHasChanged;
    }

    private void HandleCanvasClick(MouseEventArgs e)
    {
        EditorState.SelectField(null);
    }
}
