@model DynamicForms.RazorPages.Models.DynamicFieldViewModel

@{
    var fieldId = $"field_{Model.Field.Id}";
    var fieldName = $"Submission.Fields[{Model.Index}].Value";
}

<div class="form-group mb-3" data-field-id="@Model.Field.Id" data-field-type="@Model.Field.FieldType.Type.ToLower()">
    
    @* Label *@
    @if (!string.IsNullOrEmpty(Model.GetLabel()))
    {
        <label for="@fieldId" class="form-label">
            @Model.GetLabel()
            @if (Model.Field.IsRequired)
            {
                <span class="text-danger ms-1">*</span>
            }
        </label>
    }
    
    @* Render field based on type *@
    @switch (Model.Field.FieldType.Type.ToLower())
    {
        case "textbox":
            <input type="text" 
                   id="@fieldId" 
                   name="@fieldName"
                   class="@Model.GetCssClasses()"
                   value="@Model.GetStringValue()"
                   maxlength="@Model.Field.MaximumLength"
                   placeholder="@Model.GetPlaceholder()"
                   @(Model.Field.IsRequired ? "required" : "")
                   @(Model.IsReadOnly || Model.Field.ReadOnly ? "readonly" : "") />
            break;
            
        case "textarea":
            <textarea id="@fieldId" 
                      name="@fieldName"
                      class="@Model.GetCssClasses()"
                      rows="4"
                      maxlength="@Model.Field.MaximumLength"
                      placeholder="@Model.GetPlaceholder()"
                      @(Model.Field.IsRequired ? "required" : "")
                      @(Model.IsReadOnly || Model.Field.ReadOnly ? "readonly" : "")>@Model.GetStringValue()</textarea>
            break;
            
        case "dropdown":
        case "dropdownlist":
            <select id="@fieldId" 
                    name="@fieldName"
                    class="@Model.GetCssClasses()"
                    @(Model.Field.IsRequired ? "required" : "")
                    @(Model.IsReadOnly || Model.Field.ReadOnly ? "disabled" : "")>
                
                @if (!Model.Field.IsRequired)
                {
                    <option value="">@(Model.Language == "FR" ? "Sélectionnez..." : "Select...")</option>
                }
                
                @foreach (var option in Model.Field.Options.OrderBy(o => o.Order))
                {
                    var text = Model.Language == "FR" ? option.FR : option.EN;
                    var selected = option.Value == Model.GetStringValue();
                    <option value="@option.Value" selected="@selected">@text</option>
                }
            </select>
            break;
            
        case "checkbox":
            <div class="form-check">
                @{
                    var isCheckedSingle = Model.GetStringValue().Equals("true", StringComparison.OrdinalIgnoreCase) || 
                                   Model.GetStringValue().Equals("1", StringComparison.OrdinalIgnoreCase);
                }
                
                <input type="checkbox" 
                       id="@fieldId" 
                       name="@fieldName"
                       class="form-check-input @(Model.HasValidationErrors ? "is-invalid" : "")"
                       value="true"
                       checked="@isCheckedSingle"
                       @(Model.Field.IsRequired ? "required" : "")
                       @(Model.IsReadOnly || Model.Field.ReadOnly ? "disabled" : "") />
                       
                <input type="hidden" name="@fieldName" value="false" />
                
                @if (!string.IsNullOrEmpty(Model.GetLabel()))
                {
                    <label for="@fieldId" class="form-check-label">
                        @Model.GetLabel()
                        @if (Model.Field.IsRequired)
                        {
                            <span class="text-danger ms-1">*</span>
                        }
                    </label>
                }
            </div>
            break;

        case "checkboxlist":
            var selectedValues = Model.Value?.Values?.Select(v => v.Value).ToList() ?? [];
            
            foreach (var option in Model.Field.Options.OrderBy(o => o.Order))
            {
                var optionId = $"field_{Model.Field.Id}_{option.Value}";
                var checkboxName = $"Submission.Fields[{Model.Index}].MultiValues";
                var isChecked = selectedValues.Contains(option.Value ?? string.Empty);
                var text = Model.Language == "FR" ? option.FR : option.EN;
                
                <div class="form-check">
                    <input type="checkbox" 
                           id="@optionId" 
                           name="@checkboxName"
                           class="form-check-input"
                           value="@option.Value"
                           checked="@isChecked"
                           @(Model.IsReadOnly || Model.Field.ReadOnly ? "disabled" : "") />
                           
                    <label for="@optionId" class="form-check-label">@text</label>
                </div>
            }
            break;
            
        case "datebox":
            <input type="date" 
                   id="@fieldId" 
                   name="@fieldName"
                   class="@Model.GetCssClasses()"
                   value="@Model.GetStringValue()"
                   @(Model.Field.IsRequired ? "required" : "")
                   @(Model.IsReadOnly || Model.Field.ReadOnly ? "readonly" : "") />
            break;
            
        case "numbertextbox":
        case "numberbox":
            <input type="number" 
                   id="@fieldId" 
                   name="@fieldName"
                   class="@Model.GetCssClasses()"
                   value="@Model.GetStringValue()"
                   placeholder="@Model.GetPlaceholder()"
                   @(Model.Field.IsRequired ? "required" : "")
                   @(Model.IsReadOnly || Model.Field.ReadOnly ? "readonly" : "") />
            break;
            
        case "emailtextbox":
            <input type="email" 
                   id="@fieldId" 
                   name="@fieldName"
                   class="@Model.GetCssClasses()"
                   value="@Model.GetStringValue()"
                   maxlength="@Model.Field.MaximumLength"
                   placeholder="@Model.GetPlaceholder()"
                   @(Model.Field.IsRequired ? "required" : "")
                   @(Model.IsReadOnly || Model.Field.ReadOnly ? "readonly" : "") />
            break;
            
        case "telephonetextbox":
            <input type="tel" 
                   id="@fieldId" 
                   name="@fieldName"
                   class="@Model.GetCssClasses()"
                   value="@Model.GetStringValue()"
                   maxlength="@Model.Field.MaximumLength"
                   placeholder="@Model.GetPlaceholder()"
                   @(Model.Field.IsRequired ? "required" : "")
                   @(Model.IsReadOnly || Model.Field.ReadOnly ? "readonly" : "") />
            break;
            
        case "urltextbox":
            <input type="url" 
                   id="@fieldId" 
                   name="@fieldName"
                   class="@Model.GetCssClasses()"
                   value="@Model.GetStringValue()"
                   maxlength="@Model.Field.MaximumLength"
                   placeholder="@Model.GetPlaceholder()"
                   @(Model.Field.IsRequired ? "required" : "")
                   @(Model.IsReadOnly || Model.Field.ReadOnly ? "readonly" : "") />
            break;
            
        case "fileupload":
            <input type="file" 
                   id="@fieldId" 
                   name="@fieldName"
                   class="@Model.GetCssClasses()"
                   @(Model.Field.IsRequired ? "required" : "")
                   @(Model.IsReadOnly || Model.Field.ReadOnly ? "disabled" : "") />
            @if (Model.Value?.FileUploadData != null)
            {
                <div class="mt-2">
                    <small class="text-muted">
                        @(Model.Language == "FR" ? "Fichier actuel:" : "Current file:") 
                        @Model.Value.FileUploadData.FileName
                    </small>
                </div>
            }
            break;
            
        case "infobox":
            var content = Model.Field.Text.DescriptionHtml?.ToString(Model.Language) ?? 
                         Model.Field.Text.Description.ToString(Model.Language);
            <div class="alert alert-info">@Html.Raw(content)</div>
            break;
            
        case "label":
            <div class="form-label-static">@Model.Field.Text.Description.ToString(Model.Language)</div>
            break;
            
        case "table":
            <div class="table-field-container">
                <button type="button" class="btn btn-primary btn-sm mb-2" data-modal-id="@Model.Field.Modal?.Id">
                    <i class="fas fa-plus"></i>
                    @(Model.Language == "FR" ? "Ajouter" : "Add")
                </button>
                
                @if (Model.Value?.ModalRecords?.Any() == true)
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    @if (Model.Field.Modal?.Fields?.Any() == true)
                                    {
                                        var firstField = Model.Field.Modal.Fields.First();
                                        <th>@firstField.Text.Description.ToString(Model.Language)</th>
                                    }
                                    <th>@(Model.Language == "FR" ? "Actions" : "Actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in Model.Value.ModalRecords)
                                {
                                    <tr>
                                        <td>
                                            @if (record.Values?.Any() == true)
                                            {
                                                @record.Values.First().GetDisplayValue(Model.Language)
                                            }
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                    data-action="edit" data-record-id="@record.Id">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    data-action="delete" data-record-id="@record.Id">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        @(Model.Language == "FR" ? "Aucun enregistrement trouvé." : "No records found.")
                    </div>
                }
            </div>
            break;
            
        default:
            <div class="alert alert-warning">
                @(Model.Language == "FR" ? "Type de champ non supporté:" : "Unsupported field type:") 
                @Model.Field.FieldType.Type
            </div>
            break;
    }
    
    @* Hidden field for field ID *@
    <input type="hidden" name="Submission.Fields[@Model.Index].FieldId" value="@Model.Field.Id" />
    
    @* Help text *@
    @if (!string.IsNullOrEmpty(Model.GetHelpText()))
    {
        <div class="form-text">@Model.GetHelpText()</div>
    }
    
    @* Validation errors *@
    @if (Model.HasValidationErrors)
    {
        <div class="invalid-feedback d-block">@Model.GetValidationError()</div>
    }
    
</div>