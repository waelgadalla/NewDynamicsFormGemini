@* Editor header with title input and actions *@
@using VisualEditorOpus.Components.Editor.Modals
@using DynamicForms.Core.V4.Schemas

<div class="app-header">
    <div class="header-left">
        <button class="btn btn-ghost btn-icon-sm" @onclick="GoBack" title="Back to Workflow">
            <i class="bi bi-arrow-left"></i>
        </button>
        <div class="header-title" style="font-size: 16px;">
            <i class="bi bi-file-text"></i>
            <input type="text" class="title-input"
                   value="@(EditorState.CurrentModule?.TitleEn ?? "New Module")"
                   @onchange="HandleTitleChange" />
        </div>
        <Badge Variant="info" Text="@StepBadge" />
    </div>
    <div class="header-actions">
        <div class="view-switcher">
            <button class="btn btn-sm @(ActiveView == "design" ? "active" : "")"
                    @onclick="SwitchToDesign">Design</button>
            <button class="btn btn-sm btn-ghost @(ActiveView == "preview" ? "active" : "")"
                    @onclick="SwitchToPreview">Preview</button>
            <button class="btn btn-sm btn-ghost @(ActiveView == "json" ? "active" : "")"
                    @onclick="SwitchToJson">JSON</button>
        </div>
        <Button Variant="ghost" Icon="bi-box-arrow-in-down" OnClick="ShowImportModal" Title="Import JSON" />
        <Button Variant="outline" Icon="bi-info-circle" OnClick="ShowMetadata" />
        <Button Variant="primary" Icon="bi-check" Text="Save Module" OnClick="SaveModule" />
    </div>
</div>

@if (EditorState.CurrentModule is not null)
{
    <MetadataModal @bind-IsOpen="_showMetadataModal"
                   Module="EditorState.CurrentModule"
                   OnSave="HandleMetadataSave"
                   OnCancel="HandleMetadataCancel" />
}

<ImportJsonModal @bind-IsOpen="_showImportModal"
                 OnImportModule="HandleImportModule"
                 OnImportWorkflow="HandleImportWorkflow"
                 OnCancel="HandleImportCancel" />

@code {
    [Inject] private IEditorStateService EditorState { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private IToastService ToastService { get; set; } = default!;

    private string ActiveView { get; set; } = "design";
    private string StepBadge => GetStepBadge();
    private bool _showMetadataModal;
    private bool _showImportModal;

    private string GetStepBadge()
    {
        var workflow = EditorState.CurrentWorkflow;
        var module = EditorState.CurrentModule;

        if (workflow == null || module == null || workflow.ModuleIds.Length == 0)
        {
            return "Module";
        }

        var moduleIndex = Array.IndexOf(workflow.ModuleIds, module.Id);
        if (moduleIndex < 0)
        {
            return "Module";
        }

        var stepNumber = moduleIndex + 1;
        var totalSteps = workflow.ModuleIds.Length;

        return $"Step {stepNumber} of {totalSteps}";
    }

    private void GoBack() => Navigation.NavigateTo("/workflow");
    private void SwitchToDesign() => ActiveView = "design";
    private void SwitchToPreview() => ActiveView = "preview";
    private void SwitchToJson() => ActiveView = "json";

    private void HandleTitleChange(ChangeEventArgs e)
    {
        if (EditorState.CurrentModule is null) return;
        var newTitle = e.Value?.ToString() ?? "Untitled";
        var updatedModule = EditorState.CurrentModule with { TitleEn = newTitle };
        EditorState.UpdateModule(updatedModule);
    }

    private void ShowMetadata()
    {
        _showMetadataModal = true;
    }

    private void HandleMetadataSave(FormModuleSchema updatedModule)
    {
        EditorState.UpdateModule(updatedModule);
        _showMetadataModal = false;
        ToastService.ShowSuccess("Module metadata updated");
    }

    private void HandleMetadataCancel()
    {
        _showMetadataModal = false;
    }

    private void SaveModule()
    {
        ToastService.ShowSuccess("Module saved successfully");
    }

    private void ShowImportModal()
    {
        _showImportModal = true;
    }

    private void HandleImportModule(ImportResult<FormModuleSchema> result)
    {
        if (result.Mode == Modals.ImportMode.Replace)
        {
            // Replace current module entirely
            EditorState.LoadModule(result.Schema);
            ToastService.ShowSuccess($"Module '{result.Schema.TitleEn}' imported successfully");
        }
        else
        {
            // Merge: add new fields to existing module
            if (EditorState.CurrentModule is not null)
            {
                var existingFieldIds = EditorState.CurrentModule.Fields.Select(f => f.Id).ToHashSet();
                var newFields = result.Schema.Fields.Where(f => !existingFieldIds.Contains(f.Id)).ToArray();

                if (newFields.Length > 0)
                {
                    var mergedFields = EditorState.CurrentModule.Fields.Concat(newFields).ToArray();
                    var merged = EditorState.CurrentModule with { Fields = mergedFields };
                    EditorState.UpdateModule(merged);
                    ToastService.ShowSuccess($"Added {newFields.Length} new field(s) from import");
                }
                else
                {
                    ToastService.ShowInfo("No new fields to merge");
                }
            }
        }
        _showImportModal = false;
    }

    private void HandleImportWorkflow(ImportResult<FormWorkflowSchema> result)
    {
        if (result.Mode == Modals.ImportMode.Replace)
        {
            EditorState.LoadWorkflow(result.Schema);
            ToastService.ShowSuccess($"Workflow '{result.Schema.TitleEn}' imported successfully");
        }
        else
        {
            ToastService.ShowInfo("Workflow merge not supported - use Replace mode");
        }
        _showImportModal = false;
    }

    private void HandleImportCancel()
    {
        _showImportModal = false;
    }
}
