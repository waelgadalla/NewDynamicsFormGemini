@* Editor toolbar with view switcher, undo/redo and field operations *@
@implements IDisposable

<div class="editor-toolbar">
    <div class="toolbar-left">
        <span class="toolbar-title">
            @ModuleName
            @if (EditorState.IsDirty)
            {
                <span class="dirty-indicator" title="Unsaved changes">*</span>
            }
        </span>
        @if (FieldCount > 0)
        {
            <span class="toolbar-badge">@FieldCount Fields</span>
        }
        @if (_isSaving || AutoSaveService.IsSaving)
        {
            <span class="toolbar-badge saving">
                @if (AutoSaveService.IsSaving)
                {
                    <text>Auto-saving...</text>
                }
                else
                {
                    <text>Saving...</text>
                }
            </span>
        }
        else if (AutoSaveService.LastAutoSaveTime.HasValue && !EditorState.IsDirty)
        {
            <span class="toolbar-badge saved" title="Last auto-saved @AutoSaveService.LastAutoSaveTime.Value.ToLocalTime().ToString("HH:mm:ss")">
                <i class="bi bi-check-circle"></i> Saved
            </span>
        }
    </div>

    <ViewSwitcher CurrentView="@EditorState.CurrentView" OnViewChanged="HandleViewChanged" />

    <div class="toolbar-right">
        <div class="toolbar-group">
            <IconButton Icon="bi-arrow-counterclockwise" Title="Undo (Ctrl+Z)"
                        Disabled="@(!EditorState.CanUndo)" OnClick="Undo" />
            <IconButton Icon="bi-arrow-clockwise" Title="Redo (Ctrl+Y)"
                        Disabled="@(!EditorState.CanRedo)" OnClick="Redo" />
        </div>
        <div class="toolbar-group">
            <IconButton Icon="bi-files" Title="Duplicate (Ctrl+D)"
                        Disabled="@(EditorState.SelectedFieldId is null || EditorState.CurrentView != EditorView.Design)" OnClick="Duplicate" />
            <IconButton Icon="bi-trash" Title="Delete (Del)"
                        Disabled="@(EditorState.SelectedFieldId is null || EditorState.CurrentView != EditorView.Design)" OnClick="Delete" />
        </div>
        <div class="toolbar-group">
            <button class="toolbar-btn" @onclick="OpenLoadModal" title="Open saved form (Ctrl+O)">
                <i class="bi bi-folder-open"></i>
                <span>Open</span>
            </button>
            <button class="toolbar-btn primary" @onclick="SaveAsync" disabled="@(_isSaving || EditorState.CurrentModule is null)" title="Save form (Ctrl+S)">
                <i class="bi bi-save"></i>
                <span>Save</span>
            </button>
        </div>
    </div>
</div>

@* Load Module Modal *@
@if (_showLoadModal)
{
    <div class="modal-backdrop" @onclick="CloseLoadModal">
        <div class="modal-content load-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Open Saved Form</h3>
                <button class="modal-close" @onclick="CloseLoadModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                @if (_isLoadingList)
                {
                    <div class="loading-state">
                        <i class="bi bi-arrow-repeat spinning"></i>
                        <span>Loading saved forms...</span>
                    </div>
                }
                else if (_savedModules.Any())
                {
                    <div class="saved-modules-list">
                        @foreach (var module in _savedModules)
                        {
                            <div class="saved-module-item @(_selectedModuleId == module.ModuleId ? "selected" : "")"
                                 @onclick="() => SelectModule(module.ModuleId)">
                                <div class="module-info">
                                    <span class="module-title">@module.TitleEn</span>
                                    <span class="module-meta">@module.FieldCount fields | v@module.Version</span>
                                </div>
                                <div class="module-date">
                                    @module.DateUpdated.ToString("MMM dd, yyyy HH:mm")
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <i class="bi bi-folder"></i>
                        <p>No saved forms found</p>
                        <span class="empty-hint">Save your first form to see it here</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseLoadModal">Cancel</button>
                <button class="btn-primary" @onclick="LoadSelectedModule" disabled="@(_selectedModuleId is null || _isLoading)">
                    @if (_isLoading)
                    {
                        <i class="bi bi-arrow-repeat spinning"></i>
                        <span>Loading...</span>
                    }
                    else
                    {
                        <i class="bi bi-folder-open"></i>
                        <span>Open</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@inject Microsoft.JSInterop.IJSRuntime JS

@code {
    [Inject] private IEditorStateService EditorState { get; set; } = default!;
    [Inject] private IEditorPersistenceService PersistenceService { get; set; } = default!;
    [Inject] private IAutoSaveService AutoSaveService { get; set; } = default!;
    [Inject] private IToastService ToastService { get; set; } = default!;

    private int FieldCount => EditorState.CurrentModule?.Fields.Length ?? 0;
    private string ModuleName => EditorState.CurrentModule?.TitleEn ?? "Untitled Form";

    // Save/Load state
    private bool _isSaving;
    private bool _isLoading;
    private bool _isLoadingList;
    private bool _showLoadModal;
    private int? _selectedModuleId;
    private List<DynamicForms.SqlServer.Interfaces.ModuleSchemaSummary> _savedModules = new();

    protected override void OnInitialized()
    {
        EditorState.OnStateChanged += StateHasChanged;
        EditorState.OnDirtyStateChanged += HandleDirtyStateChanged;
        AutoSaveService.OnAutoSaveStateChanged += StateHasChanged;
        AutoSaveService.Start();
    }

    private async void HandleDirtyStateChanged()
    {
        try
        {
            if (EditorState.IsDirty)
            {
                await JS.InvokeVoidAsync("enableUnsavedWarning");
            }
            else
            {
                await JS.InvokeVoidAsync("disableUnsavedWarning");
            }
        }
        catch (Exception)
        {
            // Ignore JS interop errors during disposal
        }
        await InvokeAsync(StateHasChanged);
    }

    private void HandleViewChanged(EditorView view)
    {
        EditorState.SetView(view);
    }

    private void Undo()
    {
        EditorState.Undo();
    }

    private void Redo()
    {
        EditorState.Redo();
    }

    private void Duplicate()
    {
        if (EditorState.SelectedFieldId is not null)
        {
            EditorState.DuplicateField(EditorState.SelectedFieldId);
            ToastService.ShowSuccess("Field duplicated");
        }
    }

    private void Delete()
    {
        if (EditorState.SelectedFieldId is not null)
        {
            EditorState.DeleteField(EditorState.SelectedFieldId);
            ToastService.ShowSuccess("Field deleted");
        }
    }

    private async Task SaveAsync()
    {
        if (EditorState.CurrentModule is null) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            var result = await PersistenceService.SaveModuleAsync(EditorState.CurrentModule);

            if (result.Success)
            {
                EditorState.MarkClean();
                ToastService.ShowSuccess($"Form saved successfully (ID: {result.SavedId})");
            }
            else
            {
                ToastService.ShowError($"Failed to save: {result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving form: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task OpenLoadModal()
    {
        _showLoadModal = true;
        _selectedModuleId = null;
        _isLoadingList = true;
        StateHasChanged();

        try
        {
            var modules = await PersistenceService.GetAllModulesAsync();
            _savedModules = modules.ToList();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading saved forms: {ex.Message}");
            _savedModules = new();
        }
        finally
        {
            _isLoadingList = false;
            StateHasChanged();
        }
    }

    private void CloseLoadModal()
    {
        _showLoadModal = false;
        _selectedModuleId = null;
    }

    private void SelectModule(int moduleId)
    {
        _selectedModuleId = moduleId;
    }

    private async Task LoadSelectedModule()
    {
        if (_selectedModuleId is null) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            var module = await PersistenceService.LoadModuleAsync(_selectedModuleId.Value);

            if (module is not null)
            {
                EditorState.LoadModule(module);
                ToastService.ShowSuccess($"Loaded: {module.TitleEn}");
                CloseLoadModal();
            }
            else
            {
                ToastService.ShowError("Module not found");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading module: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    public async void Dispose()
    {
        EditorState.OnStateChanged -= StateHasChanged;
        EditorState.OnDirtyStateChanged -= HandleDirtyStateChanged;
        AutoSaveService.OnAutoSaveStateChanged -= StateHasChanged;
        AutoSaveService.Stop();

        // Disable unsaved warning on disposal
        try
        {
            await JS.InvokeVoidAsync("disableUnsavedWarning");
        }
        catch
        {
            // Ignore errors during disposal
        }
    }
}
