@* Editor toolbar with view switcher, undo/redo and field operations *@
@implements IDisposable

<div class="editor-toolbar">
    <div class="toolbar-left">
        <span class="toolbar-title">@ModuleName</span>
        @if (FieldCount > 0)
        {
            <span class="toolbar-badge">@FieldCount Fields</span>
        }
    </div>

    <ViewSwitcher CurrentView="@EditorState.CurrentView" OnViewChanged="HandleViewChanged" />

    <div class="toolbar-right">
        <div class="toolbar-group">
            <IconButton Icon="bi-arrow-counterclockwise" Title="Undo (Ctrl+Z)"
                        Disabled="@(!EditorState.CanUndo)" OnClick="Undo" />
            <IconButton Icon="bi-arrow-clockwise" Title="Redo (Ctrl+Y)"
                        Disabled="@(!EditorState.CanRedo)" OnClick="Redo" />
        </div>
        <div class="toolbar-group">
            <IconButton Icon="bi-files" Title="Duplicate (Ctrl+D)"
                        Disabled="@(EditorState.SelectedFieldId is null || EditorState.CurrentView != EditorView.Design)" OnClick="Duplicate" />
            <IconButton Icon="bi-trash" Title="Delete (Del)"
                        Disabled="@(EditorState.SelectedFieldId is null || EditorState.CurrentView != EditorView.Design)" OnClick="Delete" />
        </div>
        <button class="toolbar-btn primary" @onclick="Save">
            <i class="bi bi-save"></i>
            <span>Save</span>
        </button>
    </div>
</div>

@code {
    [Inject] private IEditorStateService EditorState { get; set; } = default!;
    [Inject] private IToastService ToastService { get; set; } = default!;

    private int FieldCount => EditorState.CurrentModule?.Fields.Length ?? 0;
    private string ModuleName => EditorState.CurrentModule?.TitleEn ?? "Untitled Form";

    protected override void OnInitialized()
    {
        EditorState.OnStateChanged += StateHasChanged;
    }

    private void HandleViewChanged(EditorView view)
    {
        EditorState.SetView(view);
    }

    private void Undo()
    {
        EditorState.Undo();
    }

    private void Redo()
    {
        EditorState.Redo();
    }

    private void Duplicate()
    {
        if (EditorState.SelectedFieldId is not null)
        {
            EditorState.DuplicateField(EditorState.SelectedFieldId);
            ToastService.ShowSuccess("Field duplicated");
        }
    }

    private void Delete()
    {
        if (EditorState.SelectedFieldId is not null)
        {
            EditorState.DeleteField(EditorState.SelectedFieldId);
            ToastService.ShowSuccess("Field deleted");
        }
    }

    private void Save()
    {
        // TODO: Implement actual save logic
        ToastService.ShowSuccess("Form saved");
    }

    public void Dispose()
    {
        EditorState.OnStateChanged -= StateHasChanged;
    }
}
