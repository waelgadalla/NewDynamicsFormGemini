@* Sidebar module list for workflow designer *@
@implements IDisposable
@using DynamicForms.SqlServer.Interfaces
@using DynamicForms.Core.V4.Schemas

<div class="workflow-module-list">
    <div class="workflow-module-list-header">
        <span>Modules</span>
        <Button Variant="ghost" Size="xs" Icon="bi-plus" OnClick="AddModuleAsync" />
    </div>

    <div class="workflow-module-items">
        @if (_isLoading)
        {
            <div class="workflow-loading">
                <i class="bi bi-arrow-repeat spin"></i>
                <p>Loading modules...</p>
            </div>
        }
        else if (EditorState.CurrentWorkflow is not null && EditorState.CurrentWorkflow.ModuleIds.Length > 0)
        {
            @foreach (var (moduleId, index) in EditorState.CurrentWorkflow.ModuleIds.Select((id, i) => (id, i)))
            {
                var moduleInfo = GetModuleInfo(moduleId);
                <div class="workflow-module-item @(SelectedModuleId == moduleId ? "selected" : "")"
                     @onclick="() => SelectModule(moduleId)">
                    <div class="workflow-module-item-order">@(index + 1)</div>
                    <div class="workflow-module-item-content">
                        <div class="workflow-module-item-title">@moduleInfo.Title</div>
                        <div class="workflow-module-item-meta">@moduleInfo.FieldCount field@(moduleInfo.FieldCount != 1 ? "s" : "")</div>
                    </div>
                    <div class="workflow-module-item-actions">
                        <button type="button" class="action-btn" @onclick="() => MoveUp(index)" @onclick:stopPropagation="true"
                                disabled="@(index == 0)" title="Move Up">
                            <i class="bi bi-chevron-up"></i>
                        </button>
                        <button type="button" class="action-btn" @onclick="() => MoveDown(index)" @onclick:stopPropagation="true"
                                disabled="@(index == EditorState.CurrentWorkflow.ModuleIds.Length - 1)" title="Move Down">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="workflow-empty">
                <i class="bi bi-collection"></i>
                <p>No modules yet</p>
                <Button Variant="outline" Size="sm" Text="Add First Module" OnClick="AddModuleAsync" />
            </div>
        }
    </div>
</div>

@code {
    [Inject] private IEditorStateService EditorState { get; set; } = default!;
    [Inject] private IEditorPersistenceService PersistenceService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private int? SelectedModuleId { get; set; }
    private bool _isLoading = false;
    private Dictionary<int, ModuleDisplayInfo> _moduleCache = new();

    protected override async Task OnInitializedAsync()
    {
        EditorState.OnWorkflowChanged += HandleWorkflowChangedAsync;
        await LoadModuleDataAsync();
    }

    private async Task LoadModuleDataAsync()
    {
        if (EditorState.CurrentWorkflow is null || EditorState.CurrentWorkflow.ModuleIds.Length == 0)
            return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            // Load all modules to get their metadata
            var allModules = await PersistenceService.GetAllModulesAsync();
            var moduleLookup = allModules.ToDictionary(m => m.ModuleId);

            _moduleCache.Clear();
            foreach (var moduleId in EditorState.CurrentWorkflow.ModuleIds)
            {
                if (moduleLookup.TryGetValue(moduleId, out var summary))
                {
                    _moduleCache[moduleId] = new ModuleDisplayInfo(summary.TitleEn, summary.FieldCount);
                }
                else
                {
                    // Module not in DB yet - show placeholder
                    _moduleCache[moduleId] = new ModuleDisplayInfo($"Module {moduleId}", 0);
                }
            }
        }
        catch
        {
            // On error, show fallback data
            foreach (var moduleId in EditorState.CurrentWorkflow.ModuleIds)
            {
                if (!_moduleCache.ContainsKey(moduleId))
                {
                    _moduleCache[moduleId] = new ModuleDisplayInfo($"Module {moduleId}", 0);
                }
            }
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private ModuleDisplayInfo GetModuleInfo(int moduleId)
    {
        return _moduleCache.TryGetValue(moduleId, out var info)
            ? info
            : new ModuleDisplayInfo($"Module {moduleId}", 0);
    }

    private void SelectModule(int moduleId)
    {
        SelectedModuleId = moduleId;
        Navigation.NavigateTo($"/editor/{moduleId}");
    }

    private async Task AddModuleAsync()
    {
        if (EditorState.CurrentWorkflow is null) return;

        // Get next available module ID from DB
        var newModuleId = await PersistenceService.GetNextModuleIdAsync();

        // Create a new module schema and save it to the database
        var newModule = new FormModuleSchema
        {
            Id = newModuleId,
            TitleEn = $"New Module {newModuleId}",
            TitleFr = $"Nouveau module {newModuleId}",
            DescriptionEn = "A new form module",
            Fields = Array.Empty<FormFieldSchema>()
        };

        // Save the new module to the database
        var saveResult = await PersistenceService.SaveModuleAsync(newModule);
        if (!saveResult.Success)
        {
            // Failed to save - don't add to workflow
            return;
        }

        // Add to workflow
        var newModuleIds = EditorState.CurrentWorkflow.ModuleIds.Append(newModuleId).ToArray();
        var updated = EditorState.CurrentWorkflow with { ModuleIds = newModuleIds };
        EditorState.UpdateWorkflow(updated);

        // Add to cache
        _moduleCache[newModuleId] = new ModuleDisplayInfo(newModule.TitleEn, 0);
    }

    private void MoveUp(int index)
    {
        if (EditorState.CurrentWorkflow is null || index <= 0) return;
        ReorderModules(index, index - 1);
    }

    private void MoveDown(int index)
    {
        if (EditorState.CurrentWorkflow is null) return;
        var maxIndex = EditorState.CurrentWorkflow.ModuleIds.Length - 1;
        if (index >= maxIndex) return;
        ReorderModules(index, index + 1);
    }

    private void ReorderModules(int fromIndex, int toIndex)
    {
        if (EditorState.CurrentWorkflow is null) return;

        var list = EditorState.CurrentWorkflow.ModuleIds.ToList();
        var item = list[fromIndex];
        list.RemoveAt(fromIndex);
        list.Insert(toIndex, item);

        var updated = EditorState.CurrentWorkflow with { ModuleIds = list.ToArray() };
        EditorState.UpdateWorkflow(updated);
    }

    private async void HandleWorkflowChangedAsync()
    {
        await LoadModuleDataAsync();
    }

    public void Dispose()
    {
        EditorState.OnWorkflowChanged -= HandleWorkflowChangedAsync;
    }

    private record ModuleDisplayInfo(string Title, int FieldCount);
}
