@* Individual module node in workflow designer *@

<div class="workflow-node @(IsSelected ? "selected" : "")"
     style="left: @(Position.X)px; top: @(Position.Y)px;"
     @onclick="HandleClick"
     @onclick:stopPropagation="true">
    <div class="workflow-node-header">
        <div class="workflow-node-icon">
            <i class="bi bi-file-text"></i>
        </div>
        <div class="workflow-node-title">@ModuleTitle</div>
        <button type="button" class="workflow-node-menu" @onclick="ToggleMenu" @onclick:stopPropagation="true">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
    </div>
    <div class="workflow-node-body">
        <div class="workflow-node-info">
            <span><i class="bi bi-collection"></i> @FieldCount fields</span>
            <span><i class="bi bi-shield-check"></i> @ValidationCount validations</span>
        </div>
    </div>
    <div class="workflow-node-ports">
        <div class="workflow-port workflow-port-in" title="Input"></div>
        <div class="workflow-port workflow-port-out" title="Output"></div>
    </div>

    @if (ShowMenu)
    {
        <div class="workflow-node-dropdown">
            <button type="button" @onclick="EditModule">
                <i class="bi bi-pencil"></i> Edit Module
            </button>
            <button type="button" @onclick="DuplicateModule">
                <i class="bi bi-copy"></i> Duplicate
            </button>
            <button type="button" class="danger" @onclick="HandleRemove">
                <i class="bi bi-trash"></i> Remove
            </button>
        </div>
    }
</div>

@code {
    [Parameter] public int ModuleId { get; set; }
    [Parameter] public (double X, double Y) Position { get; set; }
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public EventCallback<int> OnSelect { get; set; }
    [Parameter] public EventCallback<int> OnRemove { get; set; }
    [Parameter] public EventCallback<(int, (double, double))> OnPositionChanged { get; set; }
    [Parameter] public EventCallback<int> OnDuplicate { get; set; }

    /// <summary>
    /// Optional: Pre-loaded module schema for displaying title and field count.
    /// If not provided, will attempt to load from repository.
    /// </summary>
    [Parameter] public FormModuleSchema? ModuleSchema { get; set; }

    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private IEditorPersistenceService PersistenceService { get; set; } = default!;

    private bool ShowMenu { get; set; }
    private FormModuleSchema? _loadedModule;
    private bool _isLoading;

    private string ModuleTitle => GetModuleTitle();
    private int FieldCount => GetFieldCount();
    private int ValidationCount => GetValidationCount();

    protected override async Task OnParametersSetAsync()
    {
        // If ModuleSchema is provided via parameter, use it
        if (ModuleSchema != null)
        {
            _loadedModule = ModuleSchema;
            return;
        }

        // Otherwise, try to load from repository if we don't have it yet
        if (_loadedModule == null || _loadedModule.Id != ModuleId)
        {
            await LoadModuleAsync();
        }
    }

    private async Task LoadModuleAsync()
    {
        _isLoading = true;
        try
        {
            _loadedModule = await PersistenceService.LoadModuleAsync(ModuleId);
        }
        catch
        {
            // Silently fail - will show default values
            _loadedModule = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetModuleTitle()
    {
        if (_isLoading) return "Loading...";
        return _loadedModule?.TitleEn ?? $"Module {ModuleId}";
    }

    private int GetFieldCount()
    {
        return _loadedModule?.Fields?.Length ?? 0;
    }

    private int GetValidationCount()
    {
        if (_loadedModule?.Fields == null) return 0;
        return _loadedModule.Fields.Count(f =>
            f.Validation != null && (
                f.Validation.IsRequired ||
                f.Validation.MinLength.HasValue ||
                f.Validation.MaxLength.HasValue ||
                !string.IsNullOrEmpty(f.Validation.Pattern)
            ));
    }

    private async Task HandleClick()
    {
        ShowMenu = false;
        await OnSelect.InvokeAsync(ModuleId);
    }

    private void ToggleMenu()
    {
        ShowMenu = !ShowMenu;
    }

    private void EditModule()
    {
        ShowMenu = false;
        Navigation.NavigateTo($"/editor/{ModuleId}");
    }

    private async Task DuplicateModule()
    {
        ShowMenu = false;
        await OnDuplicate.InvokeAsync(ModuleId);
    }

    private async Task HandleRemove()
    {
        ShowMenu = false;
        await OnRemove.InvokeAsync(ModuleId);
    }
}
