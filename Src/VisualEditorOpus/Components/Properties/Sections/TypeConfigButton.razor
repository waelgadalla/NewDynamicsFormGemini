@* TypeConfig button for accessing type-specific configuration *@
@implements IDisposable

<div class="type-config-section">
    <button class="type-config-btn @(IsConfigured ? "configured" : "")"
            @onclick="OpenConfigModal">
        <div class="type-config-icon">
            <i class="bi bi-@(IsConfigured ? "check-lg" : IconName)"></i>
        </div>
        <div class="type-config-content">
            <div class="type-config-title">@Title</div>
            <div class="type-config-desc">@Description</div>
            @if (IsConfigured && ConfigSummary.Any())
            {
                <div class="config-summary">
                    @foreach (var item in ConfigSummary.Take(3))
                    {
                        <span class="config-tag">@item</span>
                    }
                </div>
            }
        </div>
        @if (IsConfigured)
        {
            <span class="type-config-badge">Configured</span>
        }
        <i class="bi bi-chevron-right type-config-arrow"></i>
    </button>
</div>

@* Config Modal *@
@if (IsModalOpen)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>@Title</h3>
                <button class="modal-close" @onclick="CloseModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                @switch (Field?.FieldType)
                {
                    case "TextBox":
                    case "Email":
                    case "Phone":
                        <TextConfigPanel Config="@TextConfig" OnChange="HandleTextConfigChange" />
                        break;
                    case "Number":
                    case "Currency":
                        <NumberConfigPanel Config="@NumberConfig" OnChange="HandleNumberConfigChange" />
                        break;
                    case "DatePicker":
                    case "DateTime":
                        <DateConfigPanel Config="@DateConfigValue" OnChange="HandleDateConfigChange" />
                        break;
                    case "FileUpload":
                        <FileConfigPanel Config="@FileConfig" OnChange="HandleFileConfigChange" />
                        break;
                    case "DataGrid":
                    case "Repeater":
                        <DataGridConfigPanel Config="@DataGridConfig" OnChange="HandleDataGridConfigChange" />
                        break;
                    case "Toggle":
                        <ToggleConfigPanel Config="@ToggleConfig" OnChange="HandleToggleConfigChange" />
                        break;
                    case "RichText":
                        <RichTextConfigPanel Config="@RichTextConfig" OnChange="HandleRichTextConfigChange" />
                        break;
                    case "Signature":
                        <SignatureConfigPanel Config="@SignatureConfigValue" OnChange="HandleSignatureConfigChange" />
                        break;
                    case "Image":
                        <ImageConfigPanel Config="@ImageConfig" OnChange="HandleImageConfigChange" />
                        break;
                    case "MatrixSingle":
                        <MatrixConfigPanel Config="@MatrixSingleConfig" MatrixType="single" OnChange="HandleMatrixSingleConfigChange" />
                        break;
                    case "MatrixMulti":
                        <MatrixConfigPanel Config="@MatrixMultiConfig" MatrixType="multi" OnChange="HandleMatrixMultiConfigChange" />
                        break;
                    default:
                        <div class="config-placeholder">
                            <i class="bi bi-gear"></i>
                            <span>No specific configuration available for this field type.</span>
                        </div>
                        break;
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveConfig">Save Configuration</button>
            </div>
        </div>
    </div>
}

@code {
    [Inject] private IEditorStateService EditorState { get; set; } = default!;

    private FormFieldSchema? Field => EditorState.SelectedField;
    private bool IsModalOpen { get; set; }

    // Typed configs for editing
    private TextConfigModel TextConfig { get; set; } = new();
    private NumberConfigModel NumberConfig { get; set; } = new();
    private DateConfigModel DateConfigValue { get; set; } = new();
    private FileConfigModel FileConfig { get; set; } = new();
    private DataGridConfigModel DataGridConfig { get; set; } = new();
    private ToggleConfigModel ToggleConfig { get; set; } = new();
    private RichTextConfigModel RichTextConfig { get; set; } = new();
    private SignatureConfigModel SignatureConfigValue { get; set; } = new();
    private ImageConfigModel ImageConfig { get; set; } = new();
    private MatrixConfigModel MatrixSingleConfig { get; set; } = new();
    private MatrixConfigModel MatrixMultiConfig { get; set; } = new();

    private bool IsConfigured => Field?.TypeConfig != null;

    private string IconName => Field?.FieldType switch
    {
        "TextBox" or "Email" or "Phone" => "sliders",
        "Number" or "Currency" => "123",
        "DatePicker" or "DateTime" => "calendar-event",
        "Time" => "clock",
        "FileUpload" => "upload",
        "Image" => "image",
        "Signature" => "pen",
        "DataGrid" or "Repeater" => "collection",
        "AutoComplete" => "search",
        "Toggle" => "toggle-on",
        "RichText" => "file-richtext",
        "MatrixSingle" or "MatrixMulti" => "grid-3x3",
        _ => "gear"
    };

    private string Title => Field?.FieldType switch
    {
        "TextBox" => "Text Options",
        "Email" => "Email Options",
        "Phone" => "Phone Options",
        "Number" => "Number Options",
        "Currency" => "Currency Options",
        "DatePicker" => "Date Options",
        "DateTime" => "DateTime Options",
        "Time" => "Time Options",
        "FileUpload" => "File Upload Options",
        "Image" => "Image Options",
        "Signature" => "Signature Options",
        "DataGrid" or "Repeater" => "Data Grid Options",
        "AutoComplete" => "Autocomplete Options",
        "Toggle" => "Toggle Options",
        "RichText" => "Rich Text Options",
        "MatrixSingle" => "Matrix (Single Select) Options",
        "MatrixMulti" => "Matrix (Multi Select) Options",
        _ => "Type Configuration"
    };

    private string Description
    {
        get
        {
            if (IsConfigured)
            {
                var count = GetConfiguredSettingsCount();
                return $"Configured with {count} setting{(count != 1 ? "s" : "")}";
            }

            return Field?.FieldType switch
            {
                "TextBox" => "Set input mask, pattern, limits",
                "Email" => "Set validation, autocomplete",
                "Phone" => "Set format, country code",
                "Number" or "Currency" => "Set min, max, step, format",
                "DatePicker" or "DateTime" => "Set range, format, disabled days",
                "Time" => "Set 12h/24h, step, range",
                "FileUpload" => "Set allowed types, size limits",
                "Image" => "Set dimensions, format, crop",
                "Signature" => "Set canvas size, stroke, legal text",
                "DataGrid" or "Repeater" => "Set columns, min/max rows",
                "AutoComplete" => "Set data source, templates",
                "Toggle" => "Set labels, colors, size",
                "RichText" => "Set toolbar, height, limits",
                "MatrixSingle" => "Set rows, columns, layout",
                "MatrixMulti" => "Set rows, columns, cell types",
                _ => "Configure type-specific settings"
            };
        }
    }

    private IEnumerable<string> ConfigSummary
    {
        get
        {
            if (Field?.TypeConfig == null) return Enumerable.Empty<string>();

            return Field.TypeConfig switch
            {
                DateConfig dc => GetDateConfigSummary(dc),
                FileUploadConfig fc => GetFileConfigSummary(fc),
                DataGridConfig dgc => GetDataGridConfigSummary(dgc),
                AutoCompleteConfig ac => GetAutoCompleteConfigSummary(ac),
                ToggleConfig tc => GetToggleConfigSummary(tc),
                RichTextConfig rtc => GetRichTextConfigSummary(rtc),
                SignatureConfig sc => GetSignatureConfigSummary(sc),
                ImageConfig ic => GetImageConfigSummary(ic),
                MatrixSingleSelectConfig msc => GetMatrixSingleConfigSummary(msc),
                MatrixMultiSelectConfig mmc => GetMatrixMultiConfigSummary(mmc),
                TextInputConfig tic => GetTextInputConfigSummary(tic),
                _ => Enumerable.Empty<string>()
            };
        }
    }

    private int GetConfiguredSettingsCount()
    {
        if (Field?.TypeConfig == null) return 0;

        return Field.TypeConfig switch
        {
            DateConfig dc => CountDateConfigSettings(dc),
            FileUploadConfig fc => CountFileConfigSettings(fc),
            DataGridConfig dgc => CountDataGridConfigSettings(dgc),
            AutoCompleteConfig ac => CountAutoCompleteConfigSettings(ac),
            ToggleConfig tc => CountToggleConfigSettings(tc),
            RichTextConfig rtc => CountRichTextConfigSettings(rtc),
            SignatureConfig sc => CountSignatureConfigSettings(sc),
            ImageConfig ic => CountImageConfigSettings(ic),
            MatrixSingleSelectConfig msc => CountMatrixSingleConfigSettings(msc),
            MatrixMultiSelectConfig mmc => CountMatrixMultiConfigSettings(mmc),
            TextInputConfig tic => CountTextInputConfigSettings(tic),
            _ => 0
        };
    }

    private IEnumerable<string> GetDateConfigSummary(DateConfig config)
    {
        if (!config.AllowFuture) yield return "No future dates";
        if (!config.AllowPast) yield return "No past dates";
        if (!string.IsNullOrEmpty(config.MinDate)) yield return $"Min: {config.MinDate}";
        if (!string.IsNullOrEmpty(config.MaxDate)) yield return $"Max: {config.MaxDate}";
    }

    private IEnumerable<string> GetFileConfigSummary(FileUploadConfig config)
    {
        if (config.AllowedExtensions.Any())
            yield return string.Join(", ", config.AllowedExtensions.Take(3));
        yield return $"Max: {config.MaxFileSizeBytes / (1024 * 1024)}MB";
        if (config.AllowMultiple) yield return "Multiple";
    }

    private IEnumerable<string> GetDataGridConfigSummary(DataGridConfig config)
    {
        yield return $"{config.Columns.Length} columns";
        if (config.MaxRows.HasValue) yield return $"Max: {config.MaxRows} rows";
        yield return config.EditorMode;
    }

    private IEnumerable<string> GetAutoCompleteConfigSummary(AutoCompleteConfig config)
    {
        yield return $"Min: {config.MinCharacters} chars";
        yield return config.DisplayField;
    }

    private int CountDateConfigSettings(DateConfig config)
    {
        int count = 0;
        if (!config.AllowFuture) count++;
        if (!config.AllowPast) count++;
        if (!string.IsNullOrEmpty(config.MinDate)) count++;
        if (!string.IsNullOrEmpty(config.MaxDate)) count++;
        return count;
    }

    private int CountFileConfigSettings(FileUploadConfig config)
    {
        int count = 0;
        if (config.AllowedExtensions.Any()) count++;
        count++; // MaxFileSizeBytes always counts
        if (config.AllowMultiple) count++;
        if (config.ScanRequired) count++;
        return count;
    }

    private int CountDataGridConfigSettings(DataGridConfig config)
    {
        int count = config.Columns.Length > 0 ? 1 : 0;
        if (config.MaxRows.HasValue) count++;
        if (!config.AllowAdd) count++;
        if (!config.AllowEdit) count++;
        if (!config.AllowDelete) count++;
        return count;
    }

    private int CountAutoCompleteConfigSettings(AutoCompleteConfig config)
    {
        int count = 2; // DataSourceUrl and ValueField are required
        if (!string.IsNullOrEmpty(config.ItemTemplate)) count++;
        return count;
    }

    // Toggle config helpers
    private IEnumerable<string> GetToggleConfigSummary(ToggleConfig config)
    {
        yield return config.Size;
        if (config.ShowLabels) yield return $"{config.OnLabelEn}/{config.OffLabelEn}";
    }

    private int CountToggleConfigSettings(ToggleConfig config)
    {
        int count = 1; // Size always counts
        if (config.ShowLabels) count++;
        if (config.OnColor != "#22c55e") count++;
        if (config.OffColor != "#e5e7eb") count++;
        return count;
    }

    // RichText config helpers
    private IEnumerable<string> GetRichTextConfigSummary(RichTextConfig config)
    {
        yield return $"{config.Toolbar.Length} tools";
        if (config.MaxCharacters.HasValue) yield return $"Max: {config.MaxCharacters}";
        if (config.AllowImages) yield return "Images";
    }

    private int CountRichTextConfigSettings(RichTextConfig config)
    {
        int count = 1; // Toolbar always counts
        if (config.MaxCharacters.HasValue) count++;
        if (config.AllowImages) count++;
        if (config.AllowTables) count++;
        if (config.AllowHtmlSource) count++;
        return count;
    }

    // Signature config helpers
    private IEnumerable<string> GetSignatureConfigSummary(SignatureConfig config)
    {
        yield return $"{config.CanvasWidth}x{config.CanvasHeight}";
        yield return config.OutputFormat.ToUpper();
        if (config.AllowTypedSignature) yield return "Typed allowed";
    }

    private int CountSignatureConfigSettings(SignatureConfig config)
    {
        int count = 2; // Canvas size and format
        if (config.AllowTypedSignature) count++;
        if (config.ShowTimestamp) count++;
        if (!string.IsNullOrEmpty(config.LegalTextEn)) count++;
        return count;
    }

    // Image config helpers
    private IEnumerable<string> GetImageConfigSummary(ImageConfig config)
    {
        yield return config.Mode;
        if (config.MaxWidth.HasValue) yield return $"Max: {config.MaxWidth}px";
        if (config.AllowCrop) yield return "Crop";
    }

    private int CountImageConfigSettings(ImageConfig config)
    {
        int count = 1; // Mode always counts
        if (config.MaxWidth.HasValue || config.MaxHeight.HasValue) count++;
        if (config.AllowCrop) count++;
        return count;
    }

    // Matrix Single config helpers
    private IEnumerable<string> GetMatrixSingleConfigSummary(MatrixSingleSelectConfig config)
    {
        yield return $"{config.Rows.Length} rows";
        yield return $"{config.Columns.Length} columns";
        if (config.IsAllRowRequired) yield return "Required";
    }

    private int CountMatrixSingleConfigSettings(MatrixSingleSelectConfig config)
    {
        int count = 0;
        if (config.Rows.Length > 0) count++;
        if (config.Columns.Length > 0) count++;
        if (config.IsAllRowRequired) count++;
        if (config.AlternateRowColors) count++;
        return count;
    }

    // Matrix Multi config helpers
    private IEnumerable<string> GetMatrixMultiConfigSummary(MatrixMultiSelectConfig config)
    {
        yield return $"{config.Rows.Length} rows";
        yield return $"{config.Columns.Length} columns";
        yield return config.DefaultCellType;
    }

    private int CountMatrixMultiConfigSettings(MatrixMultiSelectConfig config)
    {
        int count = 0;
        if (config.Rows.Length > 0) count++;
        if (config.Columns.Length > 0) count++;
        if (config.IsAllRowRequired) count++;
        if (config.AllowDynamicRows) count++;
        return count;
    }

    // TextInput config helpers
    private IEnumerable<string> GetTextInputConfigSummary(TextInputConfig config)
    {
        yield return config.InputType;
        if (!string.IsNullOrEmpty(config.InputMask)) yield return "Masked";
        if (config.ShowCountrySelector) yield return "Country";
    }

    private int CountTextInputConfigSettings(TextInputConfig config)
    {
        int count = 1; // InputType always counts
        if (!string.IsNullOrEmpty(config.InputMask)) count++;
        if (!string.IsNullOrEmpty(config.DefaultCountryCode)) count++;
        if (config.ShowCountrySelector) count++;
        return count;
    }

    protected override void OnInitialized()
    {
        EditorState.OnFieldSelected += OnFieldSelected;
    }

    private void OnFieldSelected(string? fieldId)
    {
        LoadConfigFromField();
        StateHasChanged();
    }

    private void LoadConfigFromField()
    {
        if (Field?.TypeConfig == null)
        {
            // Reset all config models to defaults
            TextConfig = new TextConfigModel();
            NumberConfig = new NumberConfigModel();
            DateConfigValue = new DateConfigModel();
            FileConfig = new FileConfigModel();
            DataGridConfig = new DataGridConfigModel();
            ToggleConfig = new ToggleConfigModel();
            RichTextConfig = new RichTextConfigModel();
            SignatureConfigValue = new SignatureConfigModel();
            ImageConfig = new ImageConfigModel();
            MatrixSingleConfig = new MatrixConfigModel();
            MatrixMultiConfig = new MatrixConfigModel();
            return;
        }

        switch (Field.TypeConfig)
        {
            case DateConfig dc:
                DateConfigValue = new DateConfigModel
                {
                    AllowFuture = dc.AllowFuture,
                    AllowPast = dc.AllowPast,
                    MinDate = dc.MinDate,
                    MaxDate = dc.MaxDate
                };
                break;
            case FileUploadConfig fc:
                FileConfig = new FileConfigModel
                {
                    AllowedExtensions = string.Join(", ", fc.AllowedExtensions),
                    MaxFileSizeMB = (int)(fc.MaxFileSizeBytes / (1024 * 1024)),
                    AllowMultiple = fc.AllowMultiple,
                    ScanRequired = fc.ScanRequired
                };
                break;
            case DataGridConfig dgc:
                DataGridConfig = new DataGridConfigModel
                {
                    AllowAdd = dgc.AllowAdd,
                    AllowEdit = dgc.AllowEdit,
                    AllowDelete = dgc.AllowDelete,
                    MaxRows = dgc.MaxRows,
                    EditorMode = dgc.EditorMode
                };
                break;
            case ToggleConfig tc:
                ToggleConfig = new ToggleConfigModel
                {
                    OnLabelEn = tc.OnLabelEn,
                    OnLabelFr = tc.OnLabelFr,
                    OffLabelEn = tc.OffLabelEn,
                    OffLabelFr = tc.OffLabelFr,
                    OnColor = tc.OnColor,
                    OffColor = tc.OffColor,
                    Size = tc.Size,
                    ShowLabels = tc.ShowLabels,
                    DefaultValue = tc.DefaultValue
                };
                break;
            case RichTextConfig rtc:
                RichTextConfig = new RichTextConfigModel
                {
                    EditorHeight = rtc.EditorHeight,
                    AllowImages = rtc.AllowImages,
                    AllowTables = rtc.AllowTables,
                    AllowHtmlSource = rtc.AllowHtmlSource,
                    MaxCharacters = rtc.MaxCharacters
                };
                break;
            case SignatureConfig sc:
                SignatureConfigValue = new SignatureConfigModel
                {
                    CanvasWidth = sc.CanvasWidth,
                    CanvasHeight = sc.CanvasHeight,
                    StrokeColor = sc.StrokeColor,
                    StrokeWidth = sc.StrokeWidth,
                    OutputFormat = sc.OutputFormat,
                    AllowTypedSignature = sc.AllowTypedSignature,
                    ShowTimestamp = sc.ShowTimestamp,
                    LegalTextEn = sc.LegalTextEn,
                    LegalTextFr = sc.LegalTextFr
                };
                break;
            case ImageConfig ic:
                ImageConfig = new ImageConfigModel
                {
                    Mode = ic.Mode,
                    ImageUrl = ic.ImageUrl,
                    AltTextEn = ic.AltTextEn,
                    MaxWidth = ic.MaxWidth,
                    MaxHeight = ic.MaxHeight,
                    AllowCrop = ic.AllowCrop,
                    CropAspectRatio = ic.CropAspectRatio
                };
                break;
            case MatrixSingleSelectConfig msc:
                MatrixSingleConfig = new MatrixConfigModel
                {
                    RowCount = msc.Rows.Length,
                    ColumnCount = msc.Columns.Length,
                    IsAllRowRequired = msc.IsAllRowRequired,
                    AlternateRowColors = msc.AlternateRowColors,
                    MobileLayout = msc.MobileLayout
                };
                break;
            case MatrixMultiSelectConfig mmc:
                MatrixMultiConfig = new MatrixConfigModel
                {
                    RowCount = mmc.Rows.Length,
                    ColumnCount = mmc.Columns.Length,
                    IsAllRowRequired = mmc.IsAllRowRequired,
                    AlternateRowColors = mmc.AlternateRowColors,
                    MobileLayout = mmc.MobileLayout,
                    DefaultCellType = mmc.DefaultCellType
                };
                break;
        }
    }

    private void OpenConfigModal()
    {
        LoadConfigFromField();
        IsModalOpen = true;
    }

    private void CloseModal()
    {
        IsModalOpen = false;
    }

    private void HandleTextConfigChange(TextConfigModel config)
    {
        TextConfig = config;
    }

    private void HandleNumberConfigChange(NumberConfigModel config)
    {
        NumberConfig = config;
    }

    private void HandleDateConfigChange(DateConfigModel config)
    {
        DateConfigValue = config;
    }

    private void HandleFileConfigChange(FileConfigModel config)
    {
        FileConfig = config;
    }

    private void HandleDataGridConfigChange(DataGridConfigModel config)
    {
        DataGridConfig = config;
    }

    private void HandleToggleConfigChange(ToggleConfigModel config)
    {
        ToggleConfig = config;
    }

    private void HandleRichTextConfigChange(RichTextConfigModel config)
    {
        RichTextConfig = config;
    }

    private void HandleSignatureConfigChange(SignatureConfigModel config)
    {
        SignatureConfigValue = config;
    }

    private void HandleImageConfigChange(ImageConfigModel config)
    {
        ImageConfig = config;
    }

    private void HandleMatrixSingleConfigChange(MatrixConfigModel config)
    {
        MatrixSingleConfig = config;
    }

    private void HandleMatrixMultiConfigChange(MatrixConfigModel config)
    {
        MatrixMultiConfig = config;
    }

    private void SaveConfig()
    {
        if (Field == null) return;

        FieldTypeConfig? typeConfig = Field.FieldType switch
        {
            "DatePicker" or "DateTime" => new DateConfig
            {
                AllowFuture = DateConfigValue.AllowFuture,
                AllowPast = DateConfigValue.AllowPast,
                MinDate = DateConfigValue.MinDate,
                MaxDate = DateConfigValue.MaxDate
            },
            "FileUpload" => new FileUploadConfig
            {
                AllowedExtensions = FileConfig.AllowedExtensions?.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(e => e.Trim()).ToArray() ?? Array.Empty<string>(),
                MaxFileSizeBytes = FileConfig.MaxFileSizeMB * 1024 * 1024,
                AllowMultiple = FileConfig.AllowMultiple,
                ScanRequired = FileConfig.ScanRequired
            },
            "DataGrid" or "Repeater" => new DataGridConfig
            {
                AllowAdd = DataGridConfig.AllowAdd,
                AllowEdit = DataGridConfig.AllowEdit,
                AllowDelete = DataGridConfig.AllowDelete,
                MaxRows = DataGridConfig.MaxRows,
                EditorMode = DataGridConfig.EditorMode
            },
            "Toggle" => new ToggleConfig
            {
                OnLabelEn = ToggleConfig.OnLabelEn,
                OnLabelFr = ToggleConfig.OnLabelFr,
                OffLabelEn = ToggleConfig.OffLabelEn,
                OffLabelFr = ToggleConfig.OffLabelFr,
                OnColor = ToggleConfig.OnColor,
                OffColor = ToggleConfig.OffColor,
                Size = ToggleConfig.Size,
                ShowLabels = ToggleConfig.ShowLabels,
                DefaultValue = ToggleConfig.DefaultValue
            },
            "RichText" => new RichTextConfig
            {
                EditorHeight = RichTextConfig.EditorHeight,
                AllowImages = RichTextConfig.AllowImages,
                AllowTables = RichTextConfig.AllowTables,
                AllowHtmlSource = RichTextConfig.AllowHtmlSource,
                MaxCharacters = RichTextConfig.MaxCharacters
            },
            "Signature" => new SignatureConfig
            {
                CanvasWidth = SignatureConfigValue.CanvasWidth,
                CanvasHeight = SignatureConfigValue.CanvasHeight,
                StrokeColor = SignatureConfigValue.StrokeColor,
                StrokeWidth = SignatureConfigValue.StrokeWidth,
                OutputFormat = SignatureConfigValue.OutputFormat,
                AllowTypedSignature = SignatureConfigValue.AllowTypedSignature,
                ShowTimestamp = SignatureConfigValue.ShowTimestamp,
                LegalTextEn = SignatureConfigValue.LegalTextEn,
                LegalTextFr = SignatureConfigValue.LegalTextFr
            },
            "Image" => new ImageConfig
            {
                Mode = ImageConfig.Mode,
                ImageUrl = ImageConfig.ImageUrl,
                AltTextEn = ImageConfig.AltTextEn,
                MaxWidth = ImageConfig.MaxWidth,
                MaxHeight = ImageConfig.MaxHeight,
                AllowCrop = ImageConfig.AllowCrop,
                CropAspectRatio = ImageConfig.CropAspectRatio
            },
            "Email" or "Phone" => new TextInputConfig
            {
                InputType = Field.FieldType.ToLower()
            },
            "MatrixSingle" => new MatrixSingleSelectConfig
            {
                IsAllRowRequired = MatrixSingleConfig.IsAllRowRequired,
                AlternateRowColors = MatrixSingleConfig.AlternateRowColors,
                MobileLayout = MatrixSingleConfig.MobileLayout
            },
            "MatrixMulti" => new MatrixMultiSelectConfig
            {
                IsAllRowRequired = MatrixMultiConfig.IsAllRowRequired,
                AlternateRowColors = MatrixMultiConfig.AlternateRowColors,
                MobileLayout = MatrixMultiConfig.MobileLayout,
                DefaultCellType = MatrixMultiConfig.DefaultCellType ?? "dropdown"
            },
            _ => null
        };

        if (typeConfig != null)
        {
            var updated = Field with { TypeConfig = typeConfig };
            EditorState.UpdateField(updated);
        }

        CloseModal();
    }

    public void Dispose()
    {
        EditorState.OnFieldSelected -= OnFieldSelected;
    }

    // Config Models for editing
    public class TextConfigModel
    {
        public string? InputMask { get; set; }
        public int? MaxLength { get; set; }
        public string? Pattern { get; set; }
        public string? Autocomplete { get; set; }
    }

    public class NumberConfigModel
    {
        public decimal? Min { get; set; }
        public decimal? Max { get; set; }
        public decimal? Step { get; set; }
        public string? Format { get; set; }
    }

    public class DateConfigModel
    {
        public bool AllowFuture { get; set; } = true;
        public bool AllowPast { get; set; } = true;
        public string? MinDate { get; set; }
        public string? MaxDate { get; set; }
    }

    public class FileConfigModel
    {
        public string? AllowedExtensions { get; set; }
        public int MaxFileSizeMB { get; set; } = 10;
        public bool AllowMultiple { get; set; }
        public bool ScanRequired { get; set; } = true;
    }

    public class DataGridConfigModel
    {
        public bool AllowAdd { get; set; } = true;
        public bool AllowEdit { get; set; } = true;
        public bool AllowDelete { get; set; } = true;
        public int? MaxRows { get; set; }
        public string EditorMode { get; set; } = "Modal";
    }

    public class ToggleConfigModel
    {
        public string OnLabelEn { get; set; } = "Yes";
        public string OnLabelFr { get; set; } = "Oui";
        public string OffLabelEn { get; set; } = "No";
        public string OffLabelFr { get; set; } = "Non";
        public string OnColor { get; set; } = "#22c55e";
        public string OffColor { get; set; } = "#e5e7eb";
        public string Size { get; set; } = "medium";
        public bool ShowLabels { get; set; } = true;
        public bool DefaultValue { get; set; } = false;
    }

    public class RichTextConfigModel
    {
        public int EditorHeight { get; set; } = 300;
        public bool AllowImages { get; set; } = false;
        public bool AllowTables { get; set; } = false;
        public bool AllowHtmlSource { get; set; } = false;
        public int? MaxCharacters { get; set; }
    }

    public class SignatureConfigModel
    {
        public int CanvasWidth { get; set; } = 400;
        public int CanvasHeight { get; set; } = 200;
        public string StrokeColor { get; set; } = "#000000";
        public int StrokeWidth { get; set; } = 2;
        public string OutputFormat { get; set; } = "png";
        public bool AllowTypedSignature { get; set; } = false;
        public bool ShowTimestamp { get; set; } = true;
        public string? LegalTextEn { get; set; }
        public string? LegalTextFr { get; set; }
    }

    public class ImageConfigModel
    {
        public string Mode { get; set; } = "Upload";
        public string? ImageUrl { get; set; }
        public string? AltTextEn { get; set; }
        public int? MaxWidth { get; set; }
        public int? MaxHeight { get; set; }
        public bool AllowCrop { get; set; } = false;
        public string? CropAspectRatio { get; set; }
    }

    public class MatrixConfigModel
    {
        public int RowCount { get; set; } = 0;
        public int ColumnCount { get; set; } = 0;
        public bool IsAllRowRequired { get; set; } = false;
        public bool AlternateRowColors { get; set; } = true;
        public string MobileLayout { get; set; } = "stacked";
        public string? DefaultCellType { get; set; } = "dropdown";
    }
}
