@*
    Renders individual field based on FieldType

    NOTE ON SIGNATURE PAD RESIZE ISSUE:
    See CanvasSignature.razor for detailed documentation about the known Blazor.SignaturePad
    resize issue on mobile devices during orientation changes.
*@
@using FieldOption = DynamicForms.Core.V4.Schemas.FieldOption
@using ImageConfig = DynamicForms.Core.V4.Schemas.ImageConfig
@using SignatureConfig = DynamicForms.Core.V4.Schemas.SignatureConfig
@using SigPad
@implements IAsyncDisposable
@inject IJSRuntime JS

<div class="form-field @(HasErrors ? "has-error" : "")">
    <label class="field-label">
        @Label
        @if (Field.Validation?.IsRequired == true)
        {
            <span class="required">*</span>
        }
    </label>

    @switch (Field.FieldType)
    {
        case "TextBox":
        case "Email":
        case "Phone":
            <input type="@InputType"
                   class="field-input @(HasErrors ? "error" : "")"
                   value="@ValueString"
                   placeholder="@Placeholder"
                   @oninput="HandleInput" />
            break;

        case "Number":
        case "Currency":
            <input type="number"
                   class="field-input @(HasErrors ? "error" : "")"
                   value="@ValueString"
                   placeholder="@Placeholder"
                   @oninput="HandleInput" />
            break;

        case "TextArea":
            <textarea class="field-input field-textarea @(HasErrors ? "error" : "")"
                      placeholder="@Placeholder"
                      @oninput="HandleInput">@ValueString</textarea>
            break;

        case "DropDown":
            <select class="field-input form-select @(HasErrors ? "error" : "")"
                    @onchange="HandleSelectChange">
                <option value="">@SelectPlaceholder</option>
                @foreach (var option in Field.Options ?? Array.Empty<FieldOption>())
                {
                    <option value="@option.Value" selected="@(ValueString == option.Value)">
                        @GetOptionLabel(option)
                    </option>
                }
            </select>
            break;

        case "RadioGroup":
            <div class="radio-group">
                @foreach (var option in Field.Options ?? Array.Empty<FieldOption>())
                {
                    <label class="radio-item">
                        <input type="radio"
                               name="@Field.Id"
                               value="@option.Value"
                               checked="@(ValueString == option.Value)"
                               @onchange="() => OnValueChange.InvokeAsync(option.Value)" />
                        <span>@GetOptionLabel(option)</span>
                    </label>
                }
            </div>
            break;

        case "CheckboxList":
            <div class="checkbox-group">
                @foreach (var option in Field.Options ?? Array.Empty<FieldOption>())
                {
                    <label class="checkbox-item">
                        <input type="checkbox"
                               value="@option.Value"
                               checked="@IsChecked(option.Value)"
                               @onchange="() => ToggleCheckbox(option.Value)" />
                        <span>@GetOptionLabel(option)</span>
                    </label>
                }
            </div>
            break;

        case "Checkbox":
            <label class="checkbox-item single-checkbox">
                <input type="checkbox"
                       checked="@(ValueString == "true")"
                       @onchange="e => OnValueChange.InvokeAsync(((bool)(e.Value ?? false)).ToString().ToLower())" />
                <span>@GetLabel(Field.LabelEn, Field.LabelFr)</span>
            </label>
            break;

        case "Toggle":
            <div class="toggle-field">
                <label class="toggle-switch">
                    <input type="checkbox"
                           checked="@(ValueString == "true")"
                           @onchange="e => OnValueChange.InvokeAsync(((bool)(e.Value ?? false)).ToString().ToLower())" />
                    <span class="toggle-slider"></span>
                </label>
            </div>
            break;

        case "DatePicker":
            <input type="date"
                   class="field-input @(HasErrors ? "error" : "")"
                   value="@ValueString"
                   @oninput="HandleInput" />
            break;

        case "DateTime":
            <input type="datetime-local"
                   class="field-input @(HasErrors ? "error" : "")"
                   value="@ValueString"
                   @oninput="HandleInput" />
            break;

        case "Time":
            <input type="time"
                   class="field-input @(HasErrors ? "error" : "")"
                   value="@ValueString"
                   @oninput="HandleInput" />
            break;

        case "FileUpload":
            <div class="file-upload-field">
                <input type="file"
                       id="@($"file_{Field.Id}")"
                       class="file-input"
                       @onchange="HandleFileChange" />
                <label for="@($"file_{Field.Id}")" class="file-label">
                    <i class="bi bi-cloud-upload"></i>
                    <span>@(Language == "fr" ? "Choisir un fichier" : "Choose file")</span>
                </label>
                @if (!string.IsNullOrEmpty(ValueString))
                {
                    <span class="file-name">@ValueString</span>
                }
            </div>
            break;

        case "RichText":
            <div class="richtext-preview">
                <div class="richtext-toolbar">
                    <button type="button" class="toolbar-btn" title="Bold"><i class="bi bi-type-bold"></i></button>
                    <button type="button" class="toolbar-btn" title="Italic"><i class="bi bi-type-italic"></i></button>
                    <button type="button" class="toolbar-btn" title="Underline"><i class="bi bi-type-underline"></i></button>
                    <span class="toolbar-divider"></span>
                    <button type="button" class="toolbar-btn" title="Bullet List"><i class="bi bi-list-ul"></i></button>
                    <button type="button" class="toolbar-btn" title="Numbered List"><i class="bi bi-list-ol"></i></button>
                    <span class="toolbar-divider"></span>
                    <button type="button" class="toolbar-btn" title="Link"><i class="bi bi-link-45deg"></i></button>
                </div>
                <div class="richtext-editor" contenteditable="true" @oninput="HandleInput">
                    @((MarkupString)(ValueString))
                </div>
            </div>
            break;

        case "Signature":
            @* See CanvasSignature.razor for detailed notes on the resize workaround *@
            @if (GetSignatureConfig() is SignatureConfig sigConfig)
            {
                @if (!string.IsNullOrEmpty(sigConfig.LegalTextEn))
                {
                    <div class="signature-legal-text">
                        <i class="bi bi-info-circle"></i>
                        @(Language == "fr" && !string.IsNullOrEmpty(sigConfig.LegalTextFr) ? sigConfig.LegalTextFr : sigConfig.LegalTextEn)
                    </div>
                }
                <div class="signature-preview" @key="_signatureRenderKey" style="width: @(sigConfig.CanvasWidth)px; height: @(sigConfig.CanvasHeight)px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <SignaturePad @bind-Value="_signatureBytes"
                                  Options="_signatureOptions"
                                  style="width: 100%; height: 100%;"
                                  ClearButtonClass="signature-clear-btn" />
                </div>
                @if (sigConfig.ShowTimestamp)
                {
                    <div class="signature-timestamp">
                        <i class="bi bi-clock"></i>
                        <span>@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</span>
                    </div>
                }
            }
            else
            {
                <div class="signature-preview" @key="_signatureRenderKey" style="width: 400px; height: 200px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <SignaturePad @bind-Value="_signatureBytes"
                                  Options="_signatureOptions"
                                  style="width: 100%; height: 100%;"
                                  ClearButtonClass="signature-clear-btn" />
                </div>
            }
            break;

        case "Image":
            <div class="image-preview">
                @if (Field.TypeConfig is ImageConfig imgConfig && imgConfig.Mode == "Display" && !string.IsNullOrEmpty(imgConfig.ImageUrl))
                {
                    <img src="@imgConfig.ImageUrl" alt="@(imgConfig.AltTextEn ?? "")" class="display-image" />
                }
                else
                {
                    <div class="image-upload-area">
                        <i class="bi bi-image"></i>
                        <span>@(Language == "fr" ? "Cliquez pour télécharger une image" : "Click to upload an image")</span>
                    </div>
                }
            </div>
            break;

        case "MatrixSingle":
            <div class="matrix-preview matrix-single">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Strongly Disagree</th>
                            <th>Disagree</th>
                            <th>Neutral</th>
                            <th>Agree</th>
                            <th>Strongly Agree</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="row-label">Statement 1</td>
                            @for (int i = 0; i < 5; i++)
                            {
                                <td><input type="radio" name="matrix_row1" /></td>
                            }
                        </tr>
                        <tr class="alt-row">
                            <td class="row-label">Statement 2</td>
                            @for (int i = 0; i < 5; i++)
                            {
                                <td><input type="radio" name="matrix_row2" /></td>
                            }
                        </tr>
                    </tbody>
                </table>
            </div>
            break;

        case "MatrixMulti":
            <div class="matrix-preview matrix-multi">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Usage</th>
                            <th>Experience</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="row-label">Item 1</td>
                            <td><select class="matrix-select"><option>Yes</option><option>No</option></select></td>
                            <td><select class="matrix-select"><option>Beginner</option><option>Advanced</option></select></td>
                            <td><input type="number" class="matrix-input" min="1" max="5" placeholder="1-5" /></td>
                        </tr>
                        <tr class="alt-row">
                            <td class="row-label">Item 2</td>
                            <td><select class="matrix-select"><option>Yes</option><option>No</option></select></td>
                            <td><select class="matrix-select"><option>Beginner</option><option>Advanced</option></select></td>
                            <td><input type="number" class="matrix-input" min="1" max="5" placeholder="1-5" /></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            break;

        case "DataGrid":
        case "Repeater":
            <div class="datagrid-preview">
                <table class="datagrid-table">
                    <thead>
                        <tr>
                            <th>Column 1</th>
                            <th>Column 2</th>
                            <th>Column 3</th>
                            <th class="action-col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="grid-input" placeholder="Value" /></td>
                            <td><input type="text" class="grid-input" placeholder="Value" /></td>
                            <td><input type="text" class="grid-input" placeholder="Value" /></td>
                            <td class="action-col">
                                <button type="button" class="btn-icon" title="Delete"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4">
                                <button type="button" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-plus"></i> @(Language == "fr" ? "Ajouter une ligne" : "Add Row")
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            break;

        default:
            <input type="text"
                   class="field-input @(HasErrors ? "error" : "")"
                   value="@ValueString"
                   placeholder="@Placeholder"
                   @oninput="HandleInput" />
            break;
    }

    @if (!string.IsNullOrEmpty(HelpText))
    {
        <div class="field-help">@HelpText</div>
    }

    @if (HasErrors)
    {
        @foreach (var error in Errors)
        {
            <div class="field-error">
                <i class="bi bi-exclamation-circle"></i>
                @error
            </div>
        }
    }
</div>

@code {
    [Parameter] public FormFieldSchema Field { get; set; } = default!;
    [Parameter] public string Language { get; set; } = "en";
    [Parameter] public object? Value { get; set; }
    [Parameter] public IEnumerable<string> Errors { get; set; } = Enumerable.Empty<string>();
    [Parameter] public EventCallback<object> OnValueChange { get; set; }

    // Signature pad fields - includes resize workaround for mobile orientation changes
    // See CanvasSignature.razor for detailed documentation on the known Blazor.SignaturePad issue
    private byte[] _signatureBytes = Array.Empty<byte>();
    private SignaturePadOptions _signatureOptions = new()
    {
        LineCap = LineCap.Round,
        LineJoin = LineJoin.Round,
        LineWidth = 2
    };
    private DotNetObjectReference<RenderedField>? _dotNetRef;
    private string _elementId = string.Empty;
    private int _signatureRenderKey = 0; // Used to force re-render on resize (workaround for mobile orientation)

    private bool HasErrors => Errors.Any();
    private string ValueString => Value?.ToString() ?? "";

    private string Label => GetLabel(Field.LabelEn, Field.LabelFr);

    private string? Placeholder => Language == "fr"
        ? Field.PlaceholderFr ?? Field.PlaceholderEn
        : Field.PlaceholderEn;

    private string? HelpText => Language == "fr"
        ? Field.HelpFr ?? Field.HelpEn
        : Field.HelpEn;

    private string SelectPlaceholder => Language == "fr"
        ? Field.PlaceholderFr ?? "Sélectionner..."
        : Field.PlaceholderEn ?? "Select...";

    private string InputType => Field.FieldType switch
    {
        "Email" => "email",
        "Phone" => "tel",
        "Password" => "password",
        _ => "text"
    };

    private SignatureConfig? GetSignatureConfig() => Field.TypeConfig as SignatureConfig;

    private string GetLabel(string? en, string? fr) =>
        Language == "fr" && !string.IsNullOrEmpty(fr) ? fr : en ?? Field.Id;

    private string GetOptionLabel(FieldOption option) =>
        Language == "fr" && !string.IsNullOrEmpty(option.LabelFr)
            ? option.LabelFr
            : option.LabelEn;

    private void HandleInput(ChangeEventArgs e)
    {
        OnValueChange.InvokeAsync(e.Value?.ToString() ?? "");
    }

    private void HandleSelectChange(ChangeEventArgs e)
    {
        OnValueChange.InvokeAsync(e.Value?.ToString() ?? "");
    }

    private void HandleFileChange(ChangeEventArgs e)
    {
        // In preview mode, just show the filename
        OnValueChange.InvokeAsync("file_selected.pdf");
    }

    private bool IsChecked(string value)
    {
        if (Value is IEnumerable<string> list)
            return list.Contains(value);
        if (Value is string str)
            return str.Split(',').Contains(value);
        return false;
    }

    private async Task ToggleCheckbox(string value)
    {
        var list = Value switch
        {
            IEnumerable<string> enumerable => enumerable.ToList(),
            string str when !string.IsNullOrEmpty(str) => str.Split(',').ToList(),
            _ => new List<string>()
        };

        if (list.Contains(value))
            list.Remove(value);
        else
            list.Add(value);

        await OnValueChange.InvokeAsync(list);
    }

    // Signature pad resize handling - workaround for mobile orientation change issue
    protected override void OnInitialized()
    {
        _elementId = $"rendered-sig-{Field.Id}-{Guid.NewGuid():N}";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Field.FieldType == "Signature")
        {
            // Register with the JavaScript resize handler for signature fields only
            _dotNetRef = DotNetObjectReference.Create(this);
            try
            {
                await JS.InvokeVoidAsync("SignatureResizeHandler.register", _elementId, _dotNetRef);
            }
            catch (JSException)
            {
                // JS may not be loaded yet or handler not available - gracefully degrade
            }
        }
    }

    /// <summary>
    /// Called by JavaScript when window is resized or orientation changes.
    /// Workaround for the Blazor.SignaturePad resize issue on mobile devices.
    /// </summary>
    [JSInvokable]
    public void OnWindowResized()
    {
        _signatureRenderKey++;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            try
            {
                await JS.InvokeVoidAsync("SignatureResizeHandler.unregister", _elementId);
            }
            catch
            {
                // Ignore errors during dispose
            }
            _dotNetRef.Dispose();
        }
    }
}
