@page "/"
@layout MainLayout

<PageTitle>Dashboard - DynamicForms Editor</PageTitle>

<div style="height: 100vh; display: flex; flex-direction: column;">
    <div class="app-header">
        <div class="header-left">
            <div class="header-title">
                <i class="bi bi-house-door"></i> Dashboard
            </div>
        </div>
        <div class="header-actions">
            <Button Variant="outline" Icon="bi-gear" Text="Settings" OnClick="GoToSettings" />
            <Button Variant="primary" Icon="bi-plus-lg" Text="New Workflow" OnClick="CreateNewWorkflow" />
        </div>
    </div>

    <div class="dashboard-body">
        <!-- Quick Start Templates -->
        <div class="dashboard-section">
            <div class="dashboard-section-header">
                <div class="dashboard-section-title">Quick Start</div>
            </div>
            <div class="templates-row">
                <TemplateCard Icon="bi-file-earmark-text" Name="Blank Form"
                              Description="Start from scratch" TemplateId="blank"
                              OnSelect="HandleTemplateSelect" />
                <TemplateCard Icon="bi-person-vcard" Name="Contact Form"
                              Description="Name, email, message" TemplateId="contact"
                              OnSelect="HandleTemplateSelect" />
                <TemplateCard Icon="bi-clipboard-check" Name="Survey"
                              Description="Multiple choice questions" TemplateId="survey"
                              OnSelect="HandleTemplateSelect" />
                <TemplateCard Icon="bi-person-plus" Name="Registration"
                              Description="User signup form" TemplateId="registration"
                              OnSelect="HandleTemplateSelect" />
                <TemplateCard Icon="bi-briefcase" Name="Job Application"
                              Description="Employment form" TemplateId="job-application"
                              OnSelect="HandleTemplateSelect" />
            </div>
        </div>

        <!-- Recent Workflows -->
        <div class="dashboard-section">
            <div class="dashboard-section-header">
                <div class="dashboard-section-title">Recent Workflows</div>
                <SearchBox Placeholder="Search workflows..." Class="width: 240px;" />
            </div>
            @if (_isLoading)
            {
                <div class="loading-state" style="padding: 40px; text-align: center;">
                    <i class="bi bi-arrow-repeat spinning" style="font-size: 2rem;"></i>
                    <p style="margin-top: 12px; color: var(--text-muted);">Loading workflows...</p>
                </div>
            }
            else
            {
                <div class="forms-grid">
                    @foreach (var workflow in RecentWorkflows)
                    {
                        <WorkflowCard Workflow="@workflow" OnSelect="OpenWorkflow" />
                    }
                    <div class="form-card form-card-new" @onclick="CreateNewWorkflow">
                        <i class="bi bi-plus-lg"></i>
                        <span>New Workflow</span>
                    </div>
                </div>
                @if (RecentWorkflows.Count == 0)
                {
                    <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.5;"></i>
                        <p style="margin-top: 12px;">No workflows yet. Create your first workflow to get started!</p>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private IToastService ToastService { get; set; } = default!;
    [Inject] private IEditorPersistenceService PersistenceService { get; set; } = default!;

    private List<WorkflowSummary> RecentWorkflows { get; set; } = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflowsAsync();
    }

    private async Task LoadWorkflowsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var workflows = await PersistenceService.GetAllWorkflowsAsync();
            RecentWorkflows = workflows
                .OrderByDescending(w => w.DateUpdated)
                .Take(20) // Limit to 20 most recent
                .Select(w => new WorkflowSummary(
                    w.WorkflowId,
                    w.TitleEn,
                    w.DescriptionEn ?? "No description",
                    w.ModuleCount,
                    "draft", // Default status
                    w.DateUpdated
                ))
                .ToList();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading workflows: {ex.Message}");
            RecentWorkflows = new List<WorkflowSummary>();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void CreateNewWorkflow()
    {
        Navigation.NavigateTo("/workflow");
    }

    private void HandleTemplateSelect(string templateId)
    {
        Navigation.NavigateTo($"/workflow?template={templateId}");
    }

    private void OpenWorkflow(int workflowId)
    {
        Navigation.NavigateTo($"/workflow/{workflowId}");
    }

    private void GoToSettings()
    {
        Navigation.NavigateTo("/settings");
    }
}
