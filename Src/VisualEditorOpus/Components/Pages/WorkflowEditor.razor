@page "/workflow"
@page "/workflow/{WorkflowId:int}"
@layout MainLayout

<PageTitle>Workflow Designer - DynamicForms Editor</PageTitle>

<div class="workflow-designer">
    <div class="app-header">
        <div class="header-left">
            <button class="btn btn-ghost btn-icon-sm" @onclick="GoBack" title="Back to Dashboard">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div class="header-title">
                <i class="bi bi-diagram-3"></i>
                <input type="text" class="title-input"
                       value="@WorkflowTitle"
                       @onchange="HandleTitleChange" />
            </div>
            <Badge Variant="@GetStatusVariant()" Text="@WorkflowStatus" />
        </div>
        <div class="header-actions">
            @if (_isSaving)
            {
                <span class="saving-indicator"><i class="bi bi-arrow-repeat spinning"></i> Saving...</span>
            }
            <Button Variant="outline" Icon="bi-play" Text="Preview" OnClick="Preview" />
            <Button Variant="outline" Icon="bi-gear" Text="Settings" OnClick="ShowSettings" />
            <Button Variant="primary" Icon="bi-check" Text="Save Workflow" OnClick="SaveAsync" Disabled="_isSaving" />
        </div>
    </div>

    <div class="workflow-body">
        @if (_isLoading)
        {
            <div class="loading-overlay">
                <div class="loading-spinner">
                    <i class="bi bi-arrow-repeat spinning"></i>
                    <span>Loading workflow...</span>
                </div>
            </div>
        }
        else
        {
            <div class="workflow-sidebar">
                <WorkflowModuleList />
            </div>
            <div class="workflow-main">
                <WorkflowCanvas />
            </div>
            <div class="workflow-properties">
                <WorkflowProperties />
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public int? WorkflowId { get; set; }

    [Inject] private IEditorStateService EditorState { get; set; } = default!;
    [Inject] private IEditorPersistenceService PersistenceService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private IToastService ToastService { get; set; } = default!;

    private string WorkflowTitle => EditorState.CurrentWorkflow?.TitleEn ?? "New Workflow";
    private string WorkflowStatus => EditorState.CurrentWorkflow?.ModuleIds.Length > 0 ? "draft" : "empty";
    private bool _isSaving;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        if (WorkflowId.HasValue)
        {
            await LoadWorkflowAsync(WorkflowId.Value);
        }
        else
        {
            await CreateNewWorkflowAsync();
        }
    }

    private async Task LoadWorkflowAsync(int id)
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var workflow = await PersistenceService.LoadWorkflowAsync(id);
            if (workflow != null)
            {
                EditorState.LoadWorkflow(workflow);
            }
            else
            {
                ToastService.ShowWarning($"Workflow {id} not found, creating new workflow");
                await CreateNewWorkflowAsync();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading workflow: {ex.Message}");
            await CreateNewWorkflowAsync();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CreateNewWorkflowAsync()
    {
        var nextId = await PersistenceService.GetNextWorkflowIdAsync();
        EditorState.CreateNewWorkflow("Untitled Workflow");

        // Update the workflow with the next available ID
        if (EditorState.CurrentWorkflow != null)
        {
            var updated = EditorState.CurrentWorkflow with { Id = nextId };
            EditorState.LoadWorkflow(updated); // Use LoadWorkflow to avoid marking dirty
        }
    }

    private void HandleTitleChange(ChangeEventArgs e)
    {
        if (EditorState.CurrentWorkflow is null) return;
        var newTitle = e.Value?.ToString() ?? "Untitled";
        var updated = EditorState.CurrentWorkflow with { TitleEn = newTitle };
        EditorState.UpdateWorkflow(updated);
    }

    private string GetStatusVariant() => WorkflowStatus switch
    {
        "published" => "published",
        "draft" => "draft",
        _ => "draft"
    };

    private void GoBack() => Navigation.NavigateTo("/");
    private void Preview() => ToastService.ShowInfo("Preview mode coming soon");
    private void ShowSettings() => ToastService.ShowInfo("Settings panel coming soon");

    private async Task SaveAsync()
    {
        if (EditorState.CurrentWorkflow is null) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            var result = await PersistenceService.SaveWorkflowAsync(EditorState.CurrentWorkflow);
            if (result.Success)
            {
                ToastService.ShowSuccess($"Workflow saved successfully (ID: {result.SavedId})");
            }
            else
            {
                ToastService.ShowError($"Failed to save: {result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving workflow: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }
}
