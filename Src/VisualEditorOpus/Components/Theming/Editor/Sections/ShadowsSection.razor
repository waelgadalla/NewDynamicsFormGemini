@* Shadows customization section with presets and individual shadow controls *@
@implements IDisposable

@using DynamicForms.Models.Theming
@using VisualEditorOpus.Services.Theming
@using VisualEditorOpus.Components.Properties
@using VisualEditorOpus.Components.Theming.Editor.Controls

<PropertySection Title="Shadows" Icon="bi-layers-half">
    <div class="shadows-section">
        @if (Shadows is not null)
        {
            @* Basic Mode: Quick Presets *@
            <div class="prop-group">
                <span class="group-label">Shadow Style</span>
                <div class="shadow-presets">
                    @foreach (var preset in _shadowPresets)
                    {
                        <button type="button"
                                class="shadow-preset-btn @(IsPresetActive(preset.Name) ? "active" : "")"
                                @onclick="@(() => ApplyPreset(preset))"
                                title="@preset.Name">
                            <div class="preset-preview">
                                <div class="preset-box" style="box-shadow: @preset.CardShadow;"></div>
                            </div>
                            <span class="preset-name">@preset.Name</span>
                        </button>
                    }
                </div>
            </div>

            @if (IsAdvancedMode)
            {
                @* Advanced Mode: Individual Shadow Controls *@
                <div class="prop-group">
                    <span class="group-label">Card Shadow</span>
                    <ShadowEditor Value="@Shadows.CardShadow"
                                  ValueChanged="HandleCardShadowChange"
                                  DefaultValue="0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)" />
                </div>

                <div class="prop-group">
                    <span class="group-label">Input Focus Shadow</span>
                    <ShadowEditor Value="@Shadows.InputFocusShadow"
                                  ValueChanged="HandleInputFocusShadowChange"
                                  DefaultValue="0 0 0 3px rgba(99, 102, 241, 0.15)" />
                </div>

                <div class="prop-group">
                    <span class="group-label">Dropdown Shadow</span>
                    <ShadowEditor Value="@Shadows.DropdownShadow"
                                  ValueChanged="HandleDropdownShadowChange"
                                  DefaultValue="0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)" />
                </div>

                <div class="prop-group">
                    <span class="group-label">Modal Shadow</span>
                    <ShadowEditor Value="@Shadows.ModalShadow"
                                  ValueChanged="HandleModalShadowChange"
                                  DefaultValue="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)" />
                </div>

                <div class="prop-group">
                    <span class="group-label">Button Hover Shadow</span>
                    <ShadowEditor Value="@Shadows.ButtonHoverShadow"
                                  ValueChanged="HandleButtonHoverShadowChange"
                                  DefaultValue="0 4px 6px -1px rgba(0, 0, 0, 0.1)" />
                </div>
            }
        }
    </div>
</PropertySection>

@code {
    [Inject] private IThemeEditorStateService ThemeState { get; set; } = default!;

    private ThemeShadows? Shadows => ThemeState.CurrentTheme?.Shadows;
    private bool IsAdvancedMode => ThemeState.IsAdvancedMode;

    private static readonly ShadowPreset[] _shadowPresets = new[]
    {
        new ShadowPreset(
            "None",
            "none",
            "none",
            "none",
            "0 0 0 3px rgba(99, 102, 241, 0.15)",
            "none"
        ),
        new ShadowPreset(
            "Subtle",
            "0 1px 2px rgba(0, 0, 0, 0.05)",
            "0 1px 2px rgba(0, 0, 0, 0.05)",
            "0 2px 4px rgba(0, 0, 0, 0.06)",
            "0 0 0 2px rgba(99, 102, 241, 0.1)",
            "0 1px 2px rgba(0, 0, 0, 0.05)"
        ),
        new ShadowPreset(
            "Medium",
            "0 4px 6px rgba(0, 0, 0, 0.1)",
            "0 4px 6px rgba(0, 0, 0, 0.1)",
            "0 10px 15px rgba(0, 0, 0, 0.1)",
            "0 0 0 3px rgba(99, 102, 241, 0.15)",
            "0 4px 6px rgba(0, 0, 0, 0.1)"
        ),
        new ShadowPreset(
            "Pronounced",
            "0 10px 15px rgba(0, 0, 0, 0.1)",
            "0 10px 20px rgba(0, 0, 0, 0.1)",
            "0 15px 25px rgba(0, 0, 0, 0.15)",
            "0 0 0 4px rgba(99, 102, 241, 0.2)",
            "0 8px 12px rgba(0, 0, 0, 0.12)"
        ),
        new ShadowPreset(
            "Heavy",
            "0 20px 25px rgba(0, 0, 0, 0.15)",
            "0 20px 30px rgba(0, 0, 0, 0.15)",
            "0 25px 50px rgba(0, 0, 0, 0.25)",
            "0 0 0 4px rgba(99, 102, 241, 0.25)",
            "0 12px 20px rgba(0, 0, 0, 0.15)"
        )
    };

    protected override void OnInitialized()
    {
        ThemeState.OnThemeChanged += HandleThemeChanged;
        ThemeState.OnAdvancedModeChanged += HandleAdvancedModeChanged;
    }

    private void HandleThemeChanged() => InvokeAsync(StateHasChanged);
    private void HandleAdvancedModeChanged(bool _) => InvokeAsync(StateHasChanged);

    private bool IsPresetActive(string presetName)
    {
        var preset = _shadowPresets.FirstOrDefault(p => p.Name == presetName);
        if (preset == null || Shadows == null) return false;

        // Compare card shadow to determine active preset
        return Shadows.CardShadow == preset.CardShadow;
    }

    private void ApplyPreset(ShadowPreset preset)
    {
        ThemeState.UpdateShadows(s =>
        {
            s.CardShadow = preset.CardShadow;
            s.DropdownShadow = preset.DropdownShadow;
            s.ModalShadow = preset.ModalShadow;
            s.InputFocusShadow = preset.InputFocusShadow;
            s.ButtonHoverShadow = preset.ButtonHoverShadow;

            // Also update the shadow scale based on the preset
            if (preset.Name == "None")
            {
                s.ShadowXSmall = "none";
                s.ShadowSmall = "none";
                s.ShadowMedium = "none";
                s.ShadowLarge = "none";
                s.ShadowXLarge = "none";
            }
            else if (preset.Name == "Subtle")
            {
                s.ShadowXSmall = "0 1px 1px rgba(0, 0, 0, 0.03)";
                s.ShadowSmall = "0 1px 2px rgba(0, 0, 0, 0.05)";
                s.ShadowMedium = "0 2px 4px rgba(0, 0, 0, 0.06)";
                s.ShadowLarge = "0 4px 6px rgba(0, 0, 0, 0.08)";
                s.ShadowXLarge = "0 8px 10px rgba(0, 0, 0, 0.1)";
            }
            else if (preset.Name == "Medium")
            {
                s.ShadowXSmall = "0 1px 2px rgba(0, 0, 0, 0.05)";
                s.ShadowSmall = "0 1px 3px rgba(0, 0, 0, 0.1)";
                s.ShadowMedium = "0 4px 6px rgba(0, 0, 0, 0.1)";
                s.ShadowLarge = "0 10px 15px rgba(0, 0, 0, 0.1)";
                s.ShadowXLarge = "0 20px 25px rgba(0, 0, 0, 0.1)";
            }
            else if (preset.Name == "Pronounced")
            {
                s.ShadowXSmall = "0 2px 4px rgba(0, 0, 0, 0.06)";
                s.ShadowSmall = "0 4px 6px rgba(0, 0, 0, 0.08)";
                s.ShadowMedium = "0 8px 12px rgba(0, 0, 0, 0.1)";
                s.ShadowLarge = "0 16px 24px rgba(0, 0, 0, 0.12)";
                s.ShadowXLarge = "0 24px 36px rgba(0, 0, 0, 0.15)";
            }
            else if (preset.Name == "Heavy")
            {
                s.ShadowXSmall = "0 4px 6px rgba(0, 0, 0, 0.08)";
                s.ShadowSmall = "0 6px 10px rgba(0, 0, 0, 0.1)";
                s.ShadowMedium = "0 12px 20px rgba(0, 0, 0, 0.12)";
                s.ShadowLarge = "0 20px 30px rgba(0, 0, 0, 0.15)";
                s.ShadowXLarge = "0 30px 45px rgba(0, 0, 0, 0.2)";
            }
        });
    }

    private void HandleCardShadowChange(string value)
    {
        ThemeState.UpdateShadows(s => s.CardShadow = value);
    }

    private void HandleInputFocusShadowChange(string value)
    {
        ThemeState.UpdateShadows(s => s.InputFocusShadow = value);
    }

    private void HandleDropdownShadowChange(string value)
    {
        ThemeState.UpdateShadows(s => s.DropdownShadow = value);
    }

    private void HandleModalShadowChange(string value)
    {
        ThemeState.UpdateShadows(s => s.ModalShadow = value);
    }

    private void HandleButtonHoverShadowChange(string value)
    {
        ThemeState.UpdateShadows(s => s.ButtonHoverShadow = value);
    }

    public void Dispose()
    {
        ThemeState.OnThemeChanged -= HandleThemeChanged;
        ThemeState.OnAdvancedModeChanged -= HandleAdvancedModeChanged;
    }

    private record ShadowPreset(
        string Name,
        string CardShadow,
        string DropdownShadow,
        string ModalShadow,
        string InputFocusShadow,
        string ButtonHoverShadow
    );
}
