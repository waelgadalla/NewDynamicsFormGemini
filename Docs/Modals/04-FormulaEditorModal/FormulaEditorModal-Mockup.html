<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormulaEditorModal - Interactive Mockup</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ===== DESIGN TOKENS ===== */
        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --primary-light: #EEF2FF;
            --primary-muted: #A5B4FC;
            --success: #10B981;
            --success-light: #D1FAE5;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8FAFC;
            --bg-tertiary: #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --border-color: #E2E8F0;
            --border-strong: #CBD5E1;
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
            --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 10px;
            --radius-2xl: 12px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
        }

        [data-theme="dark"] {
            --primary: #818CF8;
            --primary-dark: #6366F1;
            --primary-light: rgba(99, 102, 241, 0.15);
            --bg-primary: #1E293B;
            --bg-secondary: #0F172A;
            --bg-tertiary: #334155;
            --bg-code: #0D1117;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border-color: #334155;
            --border-strong: #475569;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 40px;
        }

        /* ===== DEMO HEADER ===== */
        .demo-header {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .demo-header h2 {
            font-size: 20px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .demo-header h2 i { color: var(--primary); }
        .demo-header p { color: var(--text-secondary); margin-bottom: 16px; }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { border-color: var(--border-strong); background: var(--bg-tertiary); }
        .btn-ghost { background: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-xs { padding: 4px 8px; font-size: 11px; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* ===== MODAL ===== */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
        }

        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            max-width: 800px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            transform: scale(0.95) translateY(10px);
            transition: transform var(--transition-normal);
        }

        .modal-backdrop.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i { color: var(--primary); }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .modal-close:hover { background: var(--bg-tertiary); color: var(--text-primary); }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        /* ===== FORMULA EDITOR ===== */
        .formula-editor-container {
            display: grid;
            grid-template-columns: 1fr 250px;
            gap: 20px;
        }

        .editor-main { display: flex; flex-direction: column; gap: 16px; }

        /* Code editor area */
        .code-editor-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .code-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .code-editor-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .code-editor {
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
            padding: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            width: 100%;
            min-height: 120px;
            resize: vertical;
            outline: none;
        }

        [data-theme="dark"] .code-editor {
            background: #0D1117;
        }

        .code-editor:focus {
            box-shadow: inset 0 0 0 2px var(--primary-light);
        }

        /* Syntax highlighting preview */
        .formula-preview {
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
            padding: 16px;
            min-height: 60px;
            white-space: pre-wrap;
        }

        .formula-preview .field { color: #3B82F6; }
        .formula-preview .number { color: #10B981; }
        .formula-preview .operator { color: #F59E0B; }
        .formula-preview .function { color: #8B5CF6; font-weight: 600; }
        .formula-preview .string { color: #EC4899; }
        .formula-preview .paren { color: var(--text-muted); }

        /* Operator buttons */
        .operator-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
        }

        .operator-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .operator-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .operator-btn.wide {
            width: auto;
            padding: 0 12px;
            font-size: 12px;
        }

        /* Validation status */
        .validation-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            font-size: 13px;
        }

        .validation-status.valid {
            background: var(--success-light);
            color: var(--success);
        }

        .validation-status.invalid {
            background: var(--danger-light);
            color: var(--danger);
        }

        .validation-status i { font-size: 16px; }

        /* Result preview */
        .result-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .result-preview-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .result-value {
            font-family: var(--font-mono);
            font-size: 24px;
            font-weight: 600;
            color: var(--success);
        }

        .result-type {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Sidebar */
        .editor-sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sidebar-section {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .sidebar-section-header {
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidebar-section-body {
            padding: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Field list */
        .field-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .field-item:hover {
            background: var(--bg-primary);
        }

        .field-item i {
            font-size: 14px;
            color: var(--text-muted);
        }

        .field-item-name {
            font-size: 13px;
            font-family: var(--font-mono);
        }

        .field-item-type {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Function list */
        .function-item {
            padding: 8px 10px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .function-item:hover {
            background: var(--bg-primary);
        }

        .function-name {
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 500;
            color: #8B5CF6;
        }

        .function-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Dependencies */
        .dependencies {
            padding: 12px;
        }

        .dependency-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--info-light);
            color: var(--info);
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-family: var(--font-mono);
            margin: 2px;
        }

        /* Search */
        .sidebar-search {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-search input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .sidebar-search input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--text-primary);
            color: var(--bg-primary);
            font-size: 11px;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
        }

        .tooltip:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="btn btn-outline theme-toggle" onclick="toggleTheme()">
        <i class="bi bi-moon"></i>
    </button>

    <!-- Demo Header -->
    <div class="demo-header">
        <h2><i class="bi bi-calculator"></i> FormulaEditorModal - Interactive Demo</h2>
        <p>A formula editor for computed fields. Supports field references, arithmetic operations, and built-in functions.</p>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="openModal()">
                <i class="bi bi-plus-lg"></i> Create Formula
            </button>
            <button class="btn btn-outline" onclick="openModalWithData()">
                <i class="bi bi-pencil"></i> Edit Existing Formula
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="handleBackdropClick(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-calculator"></i>
                    <span>Formula Editor</span>
                </div>
                <button class="modal-close" onclick="closeModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="formula-editor-container">
                    <!-- Main Editor -->
                    <div class="editor-main">
                        <!-- Code Editor -->
                        <div class="code-editor-wrapper">
                            <div class="code-editor-header">
                                <span class="code-editor-title">
                                    <i class="bi bi-code-slash"></i> Formula Expression
                                </span>
                                <div class="btn-group">
                                    <button class="btn btn-xs btn-ghost tooltip" data-tooltip="Format code">
                                        <i class="bi bi-braces"></i>
                                    </button>
                                    <button class="btn btn-xs btn-ghost tooltip" data-tooltip="Clear">
                                        <i class="bi bi-eraser"></i>
                                    </button>
                                </div>
                            </div>
                            <textarea class="code-editor" id="formulaEditor"
                                      oninput="updatePreview()"
                                      placeholder="Enter your formula... e.g., Quantity * UnitPrice">Quantity * UnitPrice * (1 - DiscountPercent / 100)</textarea>
                        </div>

                        <!-- Operator Bar -->
                        <div class="operator-bar">
                            <button class="operator-btn" onclick="insertOperator('+')">+</button>
                            <button class="operator-btn" onclick="insertOperator('-')">-</button>
                            <button class="operator-btn" onclick="insertOperator('*')">*</button>
                            <button class="operator-btn" onclick="insertOperator('/')">/</button>
                            <button class="operator-btn" onclick="insertOperator('%')">%</button>
                            <button class="operator-btn" onclick="insertOperator('(')">(</button>
                            <button class="operator-btn" onclick="insertOperator(')')">)</button>
                            <button class="operator-btn wide" onclick="insertOperator('IF(')">IF</button>
                            <button class="operator-btn wide" onclick="insertOperator('SUM(')">SUM</button>
                            <button class="operator-btn wide" onclick="insertOperator('AVG(')">AVG</button>
                            <button class="operator-btn wide" onclick="insertOperator('ROUND(')">ROUND</button>
                        </div>

                        <!-- Validation Status -->
                        <div class="validation-status valid" id="validationStatus">
                            <i class="bi bi-check-circle-fill"></i>
                            <span>Formula is valid</span>
                        </div>

                        <!-- Result Preview -->
                        <div class="result-preview">
                            <div class="result-preview-label">Preview Result (with sample data)</div>
                            <div class="result-value" id="resultValue">$425.00</div>
                            <div class="result-type">Type: Currency (Number)</div>
                        </div>

                        <!-- Dependencies -->
                        <div>
                            <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;">
                                <i class="bi bi-diagram-2"></i> Field Dependencies
                            </div>
                            <div>
                                <span class="dependency-tag">Quantity</span>
                                <span class="dependency-tag">UnitPrice</span>
                                <span class="dependency-tag">DiscountPercent</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="editor-sidebar">
                        <!-- Fields Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-header">
                                <i class="bi bi-ui-checks"></i> Fields
                            </div>
                            <div class="sidebar-search">
                                <input type="text" placeholder="Search fields..." oninput="filterFields(this.value)">
                            </div>
                            <div class="sidebar-section-body" id="fieldList">
                                <div class="field-item" onclick="insertField('Quantity')">
                                    <i class="bi bi-123"></i>
                                    <span class="field-item-name">Quantity</span>
                                    <span class="field-item-type">Number</span>
                                </div>
                                <div class="field-item" onclick="insertField('UnitPrice')">
                                    <i class="bi bi-currency-dollar"></i>
                                    <span class="field-item-name">UnitPrice</span>
                                    <span class="field-item-type">Currency</span>
                                </div>
                                <div class="field-item" onclick="insertField('DiscountPercent')">
                                    <i class="bi bi-percent"></i>
                                    <span class="field-item-name">DiscountPercent</span>
                                    <span class="field-item-type">Number</span>
                                </div>
                                <div class="field-item" onclick="insertField('TaxRate')">
                                    <i class="bi bi-percent"></i>
                                    <span class="field-item-name">TaxRate</span>
                                    <span class="field-item-type">Number</span>
                                </div>
                                <div class="field-item" onclick="insertField('ShippingCost')">
                                    <i class="bi bi-currency-dollar"></i>
                                    <span class="field-item-name">ShippingCost</span>
                                    <span class="field-item-type">Currency</span>
                                </div>
                                <div class="field-item" onclick="insertField('StartDate')">
                                    <i class="bi bi-calendar"></i>
                                    <span class="field-item-name">StartDate</span>
                                    <span class="field-item-type">Date</span>
                                </div>
                                <div class="field-item" onclick="insertField('EndDate')">
                                    <i class="bi bi-calendar"></i>
                                    <span class="field-item-name">EndDate</span>
                                    <span class="field-item-type">Date</span>
                                </div>
                            </div>
                        </div>

                        <!-- Functions Section -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-header">
                                <i class="bi bi-braces"></i> Functions
                            </div>
                            <div class="sidebar-section-body">
                                <div class="function-item" onclick="insertFunction('SUM(field1, field2)')">
                                    <div class="function-name">SUM()</div>
                                    <div class="function-desc">Add multiple values</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('AVG(field1, field2)')">
                                    <div class="function-name">AVG()</div>
                                    <div class="function-desc">Calculate average</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('MIN(field1, field2)')">
                                    <div class="function-name">MIN()</div>
                                    <div class="function-desc">Get minimum value</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('MAX(field1, field2)')">
                                    <div class="function-name">MAX()</div>
                                    <div class="function-desc">Get maximum value</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('ROUND(value, decimals)')">
                                    <div class="function-name">ROUND()</div>
                                    <div class="function-desc">Round to decimals</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('IF(condition, trueVal, falseVal)')">
                                    <div class="function-name">IF()</div>
                                    <div class="function-desc">Conditional value</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('CONCAT(str1, str2)')">
                                    <div class="function-name">CONCAT()</div>
                                    <div class="function-desc">Join strings</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('DATEDIFF(date1, date2)')">
                                    <div class="function-name">DATEDIFF()</div>
                                    <div class="function-desc">Days between dates</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('NOW()')">
                                    <div class="function-name">NOW()</div>
                                    <div class="function-desc">Current date/time</div>
                                </div>
                                <div class="function-item" onclick="insertFunction('COALESCE(val1, val2)')">
                                    <div class="function-name">COALESCE()</div>
                                    <div class="function-desc">First non-null value</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="testFormula()">
                        <i class="bi bi-play"></i> Test
                    </button>
                    <button class="btn btn-primary" id="saveBtn">
                        <i class="bi bi-check-lg"></i> Save Formula
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isOpen = false;

        function openModal() {
            document.getElementById('modalBackdrop').classList.add('active');
            isOpen = true;
            document.getElementById('formulaEditor').focus();
        }

        function openModalWithData() {
            openModal();
        }

        function closeModal() {
            document.getElementById('modalBackdrop').classList.remove('active');
            isOpen = false;
        }

        function handleBackdropClick(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        function insertOperator(op) {
            const editor = document.getElementById('formulaEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;

            editor.value = text.substring(0, start) + op + text.substring(end);
            editor.selectionStart = editor.selectionEnd = start + op.length;
            editor.focus();
            updatePreview();
        }

        function insertField(fieldName) {
            const editor = document.getElementById('formulaEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;

            editor.value = text.substring(0, start) + fieldName + text.substring(end);
            editor.selectionStart = editor.selectionEnd = start + fieldName.length;
            editor.focus();
            updatePreview();
        }

        function insertFunction(func) {
            const editor = document.getElementById('formulaEditor');
            const start = editor.selectionStart;
            const text = editor.value;

            editor.value = text.substring(0, start) + func + text.substring(start);
            editor.selectionStart = editor.selectionEnd = start + func.indexOf('(') + 1;
            editor.focus();
            updatePreview();
        }

        function updatePreview() {
            const formula = document.getElementById('formulaEditor').value;

            // Simple validation
            const isValid = validateFormula(formula);
            const status = document.getElementById('validationStatus');

            if (isValid) {
                status.className = 'validation-status valid';
                status.innerHTML = '<i class="bi bi-check-circle-fill"></i><span>Formula is valid</span>';
                document.getElementById('saveBtn').disabled = false;
            } else {
                status.className = 'validation-status invalid';
                status.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i><span>Formula has errors</span>';
                document.getElementById('saveBtn').disabled = true;
            }

            // Update dependencies (simple extraction)
            updateDependencies(formula);
        }

        function validateFormula(formula) {
            if (!formula.trim()) return false;

            // Check balanced parentheses
            let count = 0;
            for (let char of formula) {
                if (char === '(') count++;
                if (char === ')') count--;
                if (count < 0) return false;
            }
            return count === 0;
        }

        function updateDependencies(formula) {
            const fields = ['Quantity', 'UnitPrice', 'DiscountPercent', 'TaxRate', 'ShippingCost', 'StartDate', 'EndDate'];
            const found = fields.filter(f => formula.includes(f));

            // Update dependency display would go here
        }

        function filterFields(query) {
            const items = document.querySelectorAll('#fieldList .field-item');
            items.forEach(item => {
                const name = item.querySelector('.field-item-name').textContent.toLowerCase();
                item.style.display = name.includes(query.toLowerCase()) ? 'flex' : 'none';
            });
        }

        function testFormula() {
            // In real implementation, would evaluate with sample data
            alert('Formula tested successfully!\nResult: $425.00');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isOpen) {
                closeModal();
            }
        });

        function toggleTheme() {
            document.body.dataset.theme = document.body.dataset.theme === 'dark' ? '' : 'dark';
        }
    </script>
</body>
</html>
